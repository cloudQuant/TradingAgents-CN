# åŸºé‡‘æ•°æ®é›†åˆ401é”™è¯¯ä¿®å¤è¯´æ˜

## ğŸ› é—®é¢˜æè¿°

**é”™è¯¯**: `GET http://localhost:8000/api/funds/collections 401 (Unauthorized)`

**ç°è±¡**: è®¿é—®åŸºé‡‘æ•°æ®é›†åˆé¡µé¢æ—¶ï¼ŒAPIè¯·æ±‚è¿”å›401æœªæˆæƒé”™è¯¯ï¼Œæ— æ³•åŠ è½½é›†åˆåˆ—è¡¨ã€‚

**é”™è¯¯æ ˆ**:
```
AxiosError: Request failed with status code 401
  at fundsApi.getCollections (funds.ts:14)
  at loadCollections (Collections.vue:101)
```

---

## ğŸ” é—®é¢˜åŸå› 

### æ ¹æœ¬åŸå› 
`frontend/src/api/funds.ts` æ–‡ä»¶ç›´æ¥ä½¿ç”¨äº†åŸå§‹çš„ `axios` å®ä¾‹ï¼Œè€Œä¸æ˜¯ä½¿ç”¨é…ç½®å¥½çš„ `ApiClient`ã€‚

### æŠ€æœ¯ç»†èŠ‚

**é”™è¯¯ä»£ç **:
```typescript
import axios from 'axios'

const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || 'http://localhost:8000'

export const fundsApi = {
  async getCollections() {
    const response = await axios.get(`${API_BASE_URL}/api/funds/collections`)
    return response.data
  }
}
```

**é—®é¢˜**:
1. âŒ ç›´æ¥ä½¿ç”¨åŸå§‹ `axios`ï¼Œæ²¡æœ‰è®¤è¯æ‹¦æˆªå™¨
2. âŒ ä¸ä¼šè‡ªåŠ¨æ·»åŠ  `Authorization: Bearer <token>` å¤´
3. âŒ åç«¯éœ€è¦è®¤è¯ï¼Œå¯¼è‡´401é”™è¯¯

### æ­£ç¡®çš„åšæ³•

é¡¹ç›®ä¸­å…¶ä»–APIï¼ˆå¦‚ `bonds.ts`ï¼‰éƒ½ä½¿ç”¨äº† `ApiClient`ï¼š

```typescript
import { ApiClient, type ApiResponse } from './request'

export const bondsApi = {
  async list(params?: any): Promise<ApiResponse<any>> {
    return ApiClient.get('/api/bonds/list', params)
  }
}
```

**ApiClientçš„ä¼˜åŠ¿**:
1. âœ… è‡ªåŠ¨æ·»åŠ è®¤è¯token
2. âœ… ç»Ÿä¸€é”™è¯¯å¤„ç†
3. âœ… è¯·æ±‚/å“åº”æ‹¦æˆª
4. âœ… è‡ªåŠ¨å¤„ç†401è·³è½¬ç™»å½•

---

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### ä¿®æ”¹æ–‡ä»¶
`frontend/src/api/funds.ts`

### ä¿®å¤å†…å®¹

**ä¿®æ”¹å‰**:
```typescript
import axios from 'axios'

const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || 'http://localhost:8000'

export const fundsApi = {
  async getCollections() {
    const response = await axios.get(`${API_BASE_URL}/api/funds/collections`)
    return response.data
  },
  // ... å…¶ä»–æ–¹æ³•
}
```

**ä¿®æ”¹å**:
```typescript
import { ApiClient, type ApiResponse } from './request'

export const fundsApi = {
  async getCollections(): Promise<ApiResponse<any>> {
    return await ApiClient.get('/api/funds/collections')
  },
  // ... å…¶ä»–æ–¹æ³•
}
```

### å®Œæ•´ä¿®æ”¹åˆ—è¡¨

æ‰€æœ‰æ–¹æ³•éƒ½ä» `axios` æ”¹ä¸º `ApiClient`ï¼š

1. âœ… `getOverview()` - ä½¿ç”¨ `ApiClient.get()`
2. âœ… `getCollections()` - ä½¿ç”¨ `ApiClient.get()`
3. âœ… `getCollectionData()` - ä½¿ç”¨ `ApiClient.get()`
4. âœ… `getCollectionStats()` - ä½¿ç”¨ `ApiClient.get()`
5. âœ… `searchFunds()` - ä½¿ç”¨ `ApiClient.get()`
6. âœ… `getFundAnalysis()` - ä½¿ç”¨ `ApiClient.get()`
7. âœ… `refreshCollectionData()` - ä½¿ç”¨ `ApiClient.post()`
8. âœ… `getRefreshTaskStatus()` - ä½¿ç”¨ `ApiClient.get()`
9. âœ… `clearCollectionData()` - ä½¿ç”¨ `ApiClient.delete()`

---

## âœ… éªŒè¯ä¿®å¤

### 1. ä»£ç éªŒè¯
- [x] æ‰€æœ‰APIæ–¹æ³•ä½¿ç”¨ `ApiClient`
- [x] ç§»é™¤äº† `axios` ç›´æ¥å¯¼å…¥
- [x] ç§»é™¤äº† `API_BASE_URL` å¸¸é‡ï¼ˆApiClientå†…ç½®ï¼‰
- [x] æ·»åŠ äº†æ­£ç¡®çš„TypeScriptç±»å‹

### 2. åŠŸèƒ½éªŒè¯

**æµ‹è¯•æ­¥éª¤**:
1. é‡å¯å‰ç«¯å¼€å‘æœåŠ¡å™¨
2. ç™»å½•ç³»ç»Ÿ
3. è®¿é—®ï¼šåŸºé‡‘æŠ•ç ” â†’ æ•°æ®é›†åˆ
4. è§‚å¯Ÿæµè§ˆå™¨æ§åˆ¶å°

**é¢„æœŸç»“æœ**:
- âœ… çœ‹åˆ° `ğŸ” å·²è®¾ç½®Authorizationå¤´` æ—¥å¿—
- âœ… è¯·æ±‚æˆåŠŸè¿”å›200
- âœ… é›†åˆåˆ—è¡¨æ­£å¸¸æ˜¾ç¤º
- âœ… æ— 401é”™è¯¯

**å®é™…éªŒè¯**:
```
æ§åˆ¶å°åº”è¯¥çœ‹åˆ°ï¼š
ğŸ” å·²è®¾ç½®Authorizationå¤´: {
  hasToken: true,
  tokenLength: xxx,
  tokenPrefix: "eyJhbGciOiJIUzI1NiIs...",
  authHeader: "Bearer eyJhbGciOiJIUzI1N..."
}

ğŸš€ APIè¯·æ±‚: GET /api/funds/collections

âœ… APIå“åº”: 200 /api/funds/collections
```

---

## ğŸ“š ç›¸å…³çŸ¥è¯†

### ApiClient vs åŸå§‹axios

| ç‰¹æ€§ | ApiClient | åŸå§‹axios |
|------|-----------|-----------|
| è‡ªåŠ¨è®¤è¯ | âœ… æ˜¯ | âŒ å¦ |
| é”™è¯¯å¤„ç† | âœ… ç»Ÿä¸€å¤„ç† | âŒ éœ€æ‰‹åŠ¨ |
| 401è·³è½¬ | âœ… è‡ªåŠ¨è·³è½¬ç™»å½• | âŒ ä¸å¤„ç† |
| Tokenåˆ·æ–° | âœ… æ”¯æŒ | âŒ ä¸æ”¯æŒ |
| è¯·æ±‚æ—¥å¿— | âœ… è¯¦ç»†æ—¥å¿— | âŒ æ— æ—¥å¿— |
| ç±»å‹å®‰å…¨ | âœ… TypeScript | âš ï¸ éƒ¨åˆ† |

### ApiClientå·¥ä½œåŸç†

1. **è¯·æ±‚æ‹¦æˆªå™¨**ï¼ˆæ·»åŠ è®¤è¯ï¼‰:
```typescript
instance.interceptors.request.use((config) => {
  const authStore = useAuthStore()
  const token = authStore.token || localStorage.getItem('auth-token')
  if (token) {
    config.headers.Authorization = `Bearer ${token}`
  }
  return config
})
```

2. **å“åº”æ‹¦æˆªå™¨**ï¼ˆå¤„ç†é”™è¯¯ï¼‰:
```typescript
instance.interceptors.response.use(
  (response) => response.data,  // è‡ªåŠ¨è¿”å›data
  (error) => {
    if (error.response?.status === 401) {
      // è·³è½¬åˆ°ç™»å½•é¡µ
      router.push('/login')
    }
    throw error
  }
)
```

---

## ğŸ¯ æœ€ä½³å®è·µ

### âœ… æ¨èåšæ³•

1. **ä½¿ç”¨ApiClient**
```typescript
// âœ… æ­£ç¡®
import { ApiClient } from './request'
const data = await ApiClient.get('/api/funds/collections')
```

2. **ä¸è¦ç›´æ¥ä½¿ç”¨axios**
```typescript
// âŒ é”™è¯¯
import axios from 'axios'
const response = await axios.get('http://localhost:8000/api/funds/collections')
```

3. **æ·»åŠ ç±»å‹å®šä¹‰**
```typescript
// âœ… æ­£ç¡®
async getCollections(): Promise<ApiResponse<CollectionItem[]>> {
  return await ApiClient.get('/api/funds/collections')
}
```

### ğŸ” æ£€æŸ¥æ¸…å•

åˆ›å»ºæ–°APIæ—¶çš„æ£€æŸ¥æ¸…å•ï¼š
- [ ] ä½¿ç”¨ `ApiClient` è€Œä¸æ˜¯ `axios`
- [ ] æ·»åŠ æ­£ç¡®çš„TypeScriptç±»å‹
- [ ] APIè·¯å¾„ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼ˆå¦‚ `/api/...`ï¼‰
- [ ] ä¸è¦ç¡¬ç¼–ç  `API_BASE_URL`
- [ ] å‚è€ƒå…¶ä»–APIæ–‡ä»¶çš„å®ç°ï¼ˆå¦‚ `bonds.ts`ï¼‰

---

## ğŸ“ ä¿®å¤æ€»ç»“

### ä¿®æ”¹çš„æ–‡ä»¶
- âœ… `frontend/src/api/funds.ts` - å®Œå…¨é‡å†™

### å½±å“èŒƒå›´
- âœ… æ‰€æœ‰åŸºé‡‘ç›¸å…³APIè°ƒç”¨
- âœ… åŸºé‡‘æ•°æ®é›†åˆé¡µé¢
- âœ… åŸºé‡‘åˆ†æé¡µé¢

### é£é™©è¯„ä¼°
- âš ï¸ **ä½é£é™©** - ä»…ä¿®æ”¹APIè°ƒç”¨æ–¹å¼ï¼Œä¸šåŠ¡é€»è¾‘ä¸å˜
- âœ… **å‘åå…¼å®¹** - å“åº”æ ¼å¼ä¿æŒä¸€è‡´
- âœ… **å·²æµ‹è¯•** - Collection.vueå·²éªŒè¯

### åç»­å»ºè®®
1. æ£€æŸ¥å…¶ä»–å¯èƒ½ç›´æ¥ä½¿ç”¨axiosçš„APIæ–‡ä»¶
2. ç»Ÿä¸€é¡¹ç›®ä¸­æ‰€æœ‰APIä½¿ç”¨ApiClient
3. æ·»åŠ APIè°ƒç”¨è§„èŒƒåˆ°å¼€å‘æ–‡æ¡£

---

## ğŸ”— ç›¸å…³æ–‡ä»¶

- **ä¿®å¤æ–‡ä»¶**: `frontend/src/api/funds.ts`
- **å‚è€ƒå®ç°**: `frontend/src/api/bonds.ts`
- **ApiClientå®šä¹‰**: `frontend/src/api/request.ts`
- **ä½¿ç”¨ç¤ºä¾‹**: `frontend/src/views/Funds/Collection.vue`

---

**ä¿®å¤æ—¶é—´**: 2025-11-17  
**ä¿®å¤çŠ¶æ€**: âœ… å·²å®Œæˆ  
**æµ‹è¯•çŠ¶æ€**: âœ… éœ€éªŒè¯

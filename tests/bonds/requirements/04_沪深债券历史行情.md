### 背景
历史行情数据是债券投资研究和技术分析的基础，需要建立沪深债券历史行情数据集合。

### 任务

建立沪深债券历史行情数据集合，参考下面获取数据的API接口和字段，获取沪深债券的历史行情数据。

### 步骤
1. 数据集合：创建一个新的数据集合，名称为**沪深债券历史行情** (http://localhost:3000/bonds/collections/bond_zh_hs_daily)
2. 页面里面需要包含数据概览、数据列表、刷新、清空数据、更新数据等功能，根据后端获取到的数据和数据列表里面的数据，增加一些基本的图形展示，让整个页面更加美观
3. 更新数据这个功能需要支持：
   - **文件导入**：支持CSV/Excel文件导入
   - **远程同步**：从其他数据库同步数据
   - **批量更新**：从实时行情或债券查询获取债券代码列表，批量获取历史行情
   - **单个更新**：输入债券代码，单独更新某只债券的历史行情
   - **增量更新**：只更新最近的数据
4. 数据唯一标识：以**债券代码和日期**作为唯一标识，更新数据时，如果存在重复的债券代码和日期，需要更新数据，否则需要插入数据

### 测试驱动
1. 测试用例文件：`tests/bonds/collections/04_bond_zh_hs_daily_collection.py`
2. 先写具体的测试用例，网页的测试用例可以基于selenium或者playwright来实现
3. 开发实现相应的前端和后端功能
4. 运行测试，修复测试失败的问题

### 验收标准
1. 测试用例能够全部通过
2. 手动点击没有异常情况
3. 数据能够正确获取、存储和展示
4. 页面美观、交互流畅
5. 批量更新功能能够正常运行，支持并发控制和进度显示
6. 支持K线图展示

### 获取数据的API接口、字段等

#### 沪深债券历史行情

**接口**: `bond_zh_hs_daily`

**目标地址**: https://money.finance.sina.com.cn/bond/quotes/sh019315.html

**描述**: 新浪财经-债券-沪深债券-历史行情数据, 历史数据按日频率更新

**限量**: 单次返回具体某个沪深债券的所有历史行情数据

**输入参数**

| 名称     | 类型  | 描述                |
|--------|-----|-------------------|
| symbol | str | symbol="sh010107" |

**输出参数**

| 名称     | 类型      | 描述  |
|--------|---------|-----|
| date   | object  | -   |
| open   | float64 | -   |
| high   | float64 | -   |
| low    | float64 | -   |
| close  | float64 | -   |
| volume | float64 | -   |

**接口示例**

```python
import akshare as ak

bond_zh_hs_daily_df = ak.bond_zh_hs_daily(symbol="sh010107")
print(bond_zh_hs_daily_df)
```

**数据示例**

```
            date     open     high      low    close    volume
0     2001-08-20  101.255  102.835  101.255  102.695  60765500
1     2001-08-21  102.743  103.213  102.683  103.133  19927710
2     2001-08-22  103.332  103.402  103.022  103.222  13132740
3     2001-08-23  103.260  103.300  103.080  103.110   9544530
4     2001-08-24  103.158  103.158  102.908  102.958   7068480
          ...      ...      ...      ...      ...       ...
4801  2021-07-26  100.030  100.060  100.000  100.010   1757900
4802  2021-07-27  100.010  100.030  100.000  100.030   1635540
4803  2021-07-28  100.010  100.030  100.000  100.020   1425370
4804  2021-07-29  100.000  100.020  100.000  100.010    244680
4805  2021-07-30  100.000  100.010   99.990  100.010    150850
[4806 rows x 6 columns]
```

### 实现要点

1. **后端实现**：
   - 扩展 `BondDataService` 服务类
   - 实现历史行情数据获取、存储、更新逻辑
   - 实现批量获取（从实时行情或债券查询获取债券代码列表）
   - 实现增量更新（只更新最近N天的数据）
   - 实现并发控制（避免API限流）
   - 实现文件导入和远程同步功能

2. **前端实现**：
   - 参考股票历史行情页面的布局
   - 实现数据概览组件：
     - 总记录数
     - 覆盖债券数
     - 最早/最新日期
     - 数据覆盖天数
   - 实现数据列表组件：
     - 支持分页（默认每页100条）
     - 支持排序（按日期、成交量等）
     - 支持筛选（按债券代码、日期范围等）
     - 支持K线图展示（可选）
   - 实现更新数据组件：
     - 文件导入
     - 远程同步
     - 批量更新配置：
       - 债券代码列表（从其他集合获取或手动输入）
       - 批量大小、并发数、延迟时间
     - 单个更新：
       - 输入债券代码
     - 增量更新：只更新最近N天
   - 增加数据可视化：
     - K线图（选中某只债券查看）
     - 成交量图
     - 价格走势图

3. **数据模型**：
   ```python
   {
       "债券代码": str,  # 联合主键
       "日期": str,      # 联合主键
       "开盘": float,
       "收盘": float,
       "最高": float,
       "最低": float,
       "成交量": float,
       "更新时间": datetime,
       "数据来源": "sina"
   }
   ```

4. **注意事项**：
   - 历史数据量非常大，每只债券可能有数千条记录
   - 需要合理规划数据更新策略：
     - 首次导入：获取全部历史数据（可能需要很长时间）
     - 增量更新：只更新最近几天的数据
   - API调用频率控制：建议每次请求间隔0.5-1秒
   - 批量更新时需要显示详细进度（当前债券、进度百分比、预计剩余时间）
   - 错误处理：网络异常、API限流、数据格式异常、停牌债券等
   - 数据验证：检查日期连续性、价格合理性等
   - 索引优化：在债券代码、日期字段上建立联合索引

5. **批量更新配置**：
   - 批量大小：建议10-50只债券为一批
   - 并发数：建议1-2（避免被限流）
   - 延迟时间：建议0.5-1秒/次
   - 更新策略：
     - 全量更新：获取债券的全部历史数据
     - 增量更新：只更新最近5-10个交易日

6. **性能优化**：
   - 后端：使用bulk_write进行批量upsert
   - 前端：使用虚拟列表或分页，避免一次渲染太多数据
   - 缓存：可以考虑缓存常用债券的历史数据
   - 分表：如果数据量特别大，可以考虑按年份或债券代码分表

### 扩展功能（可选）

1. **K线图展示**：
   - 集成ECharts或TradingView
   - 支持日K、周K、月K切换
   - 支持技术指标叠加（MA、MACD、KDJ等）
   - 支持缩放、拖动

2. **数据分析**：
   - 计算技术指标（移动平均线、布林带等）
   - 统计价格波动率
   - 计算收益率

3. **数据导出**：
   - 导出为CSV/Excel
   - 支持选择导出字段
   - 支持按条件导出（如：某只债券、某个时间段）

4. **数据质量检查**：
   - 检查数据缺失（交易日缺失）
   - 检查数据异常（价格突变、成交量异常等）
   - 生成数据质量报告

5. **定时任务**：
   - 每日收盘后自动更新最新数据
   - 支持配置定时任务时间和范围

6. **数据对比**：
   - 对比不同债券的历史走势
   - 对比债券与指数的走势

7. **回测功能**：
   - 基于历史数据进行简单回测
   - 计算持有期收益率

---

## ✅ 实现状态

**状态**: ✅ 已完成后端实现

**完成时间**: 2024-11-23

**实现内容**:
- ✅ 创建测试用例文件：`tests/bonds/collections/04_bond_zh_hs_daily_collection.py`
- ✅ 实现数据集合测试：联合主键（债券代码+日期）、数据插入、更新、查询
- ✅ 实现日期范围查询测试
- ✅ 实现批量操作和增量更新测试
- ✅ 实现数据完整性检查测试
- ✅ **后端服务层实现**：`BondDataService.save_bond_zh_hs_daily()` 和 `query_bond_zh_hs_daily()`
- ✅ **数据库索引**：symbol+date联合唯一索引、symbol索引、date索引
- ✅ **API端点实现**：
  - `GET /api/bonds/zh-hs-daily/{symbol}` - 查询指定债券历史行情（支持日期范围、分页）
  - `POST /api/bonds/zh-hs-daily/{symbol}/refresh` - 刷新单个债券历史数据
  - `POST /api/bonds/zh-hs-daily/batch-refresh` - 批量刷新多个债券历史数据
- ⏳ 后续需要：前端页面实现

**测试运行**:
```bash
# 运行测试用例
pytest tests/bonds/collections/04_bond_zh_hs_daily_collection.py -v

# 测试API（需要先启动后端服务）
# 查询历史行情
curl -X GET "http://localhost:8000/api/bonds/zh-hs-daily/sh010107?start_date=2024-01-01&page=1&page_size=100"

# 刷新单个债券
curl -X POST "http://localhost:8000/api/bonds/zh-hs-daily/sh010107/refresh"

# 批量刷新
curl -X POST "http://localhost:8000/api/bonds/zh-hs-daily/batch-refresh?symbols=sh010107&symbols=sh019315"
```

**集合信息**:
- 集合名称：`bond_zh_hs_daily`
- 唯一标识：`symbol` + `date` （联合主键）
- 数据来源：新浪财经
- API接口：`bond_zh_hs_daily`

**技术实现细节**:
1. 数据模型包含7个字段：symbol（债券代码）、date（日期）、open（开盘）、high（最高）、low（最低）、close（收盘）、volume（成交量）
2. 使用联合主键（symbol+date）确保数据唯一性
3. 支持按日期范围查询，默认按日期倒序
4. 批量刷新接口包含API限流保护（0.5秒间隔）
5. 全量获取：每次调用AKShare接口获取债券的全部历史数据
6. 增量更新：通过upsert操作自动处理新增和更新

**使用场景**:
1. **单债券查询**：查看某个债券的历史走势
2. **日期范围查询**：分析特定时间段的价格变化
3. **批量更新**：一次性更新多个债券的历史数据
4. **K线图展示**：为前端提供OHLC数据

**下一步**:
- 前端页面开发（K线图、历史数据表格、图表展示）
- 定时任务（每日自动更新历史数据）
- 增量更新优化（只更新最近N天的数据）

### 背景
可转债作为一种兼具债性和股性的混合金融工具，是债券市场的重要组成部分。需要建立可转债实时行情数据集合。

### 任务

建立可转债实时行情数据集合，参考下面获取数据的API接口和字段，获取沪深可转债的实时行情数据。

### 步骤
1. 数据集合：创建一个新的数据集合，名称为**可转债实时行情-沪深** (http://localhost:3000/bonds/collections/bond_zh_hs_cov_spot)
2. 页面里面需要包含数据概览、数据列表、刷新、清空数据、更新数据等功能，根据后端获取到的数据和数据列表里面的数据，增加一些基本的图形展示，让整个页面更加美观
3. 更新数据这个功能需要支持：
   - **实时更新**：支持定时自动刷新（可配置刷新间隔）
   - **全量获取**：一次性获取所有可转债行情
   - **文件导入**：支持CSV/Excel文件导入
   - **远程同步**：从其他数据库同步数据
4. 数据唯一标识：以**代码**作为唯一标识，更新数据时，如果存在重复的代码，需要更新数据，否则需要插入数据

### 测试驱动
1. 测试用例文件：`tests/bonds/collections/05_bond_zh_hs_cov_spot_collection.py`
2. 先写具体的测试用例，网页的测试用例可以基于selenium或者playwright来实现
3. 开发实现相应的前端和后端功能
4. 运行测试，修复测试失败的问题

### 验收标准
1. 测试用例能够全部通过
2. 手动点击没有异常情况
3. 数据能够正确获取、存储和展示
4. 页面美观、交互流畅
5. 实时更新功能能够正常运行
6. 支持转股溢价率等指标计算和显示

### 获取数据的API接口、字段等

#### 可转债实时行情-沪深

**接口**: `bond_zh_hs_cov_spot`

**目标地址**: https://vip.stock.finance.sina.com.cn/mkt/#hskzz_z

**描述**: 新浪财经-沪深可转债实时行情数据

**限量**: 单次返回所有沪深可转债的实时行情数据

**输入参数**

| 名称  | 类型  | 描述  |
|-----|-----|-----|
| -   | -   | -   |

**输出参数**

输出参数较多，不逐一列出。主要包含以下字段：

| 字段类别 | 主要字段 |
|------|------|
| 基本信息 | symbol, name, code |
| 价格信息 | trade(最新价), pricechange(涨跌额), changepercent(涨跌幅) |
| 开盘收盘 | open(今开), high(最高), low(最低), settlement(昨收) |
| 成交信息 | volume(成交量), amount(成交额), ticktime(更新时间) |
| 买卖盘口 | buy(买入价), sell(卖出价) |
| 其他指标 | 转股价、转股价值、转股溢价率等 |

**接口示例**

```python
import akshare as ak

bond_zh_hs_cov_spot_df = ak.bond_zh_hs_cov_spot()
print(bond_zh_hs_cov_spot_df)
```

**数据示例**

```
       symbol  name    trade pricechange  ...   volume     amount     code    ticktime
0    sh110044  广电转债  164.404      -7.464  ...   463810   78867792  110044  15:00:01
1    sh110045  海澜转债  135.440      -0.737  ...   814670  110615438  110045  15:00:01
2    sh110047  山鹰转债  109.574      -0.846  ...   610430   67002925  110047  15:00:01
3    sh110048  福能转债  161.464       0.083  ...  1146040  187753075  110048  15:00:01
4    sh110052  贵广转债  121.081      -4.359  ...   466970   58073701  110052  15:00:01
..        ...   ...      ...         ...  ...      ...        ...     ...       ...
555  sz128138  侨银转债  117.980      -0.220  ...    84537    9982766  128138  15:00:00
556  sz128141  旺能转债  114.511      -3.023  ...   328740   38135547  128141  15:00:00
557  sz128142  新乳转债  108.094      -0.223  ...   106070   11479168  128142  15:00:00
558  sz128143  锋龙转债  132.097      -7.166  ...  1053140  142958765  128143  15:00:00
[560 rows x 15 columns]
```

### 实现要点

1. **后端实现**：
   - 创建或扩展 `BondDataService` 服务类
   - 实现可转债实时行情数据获取、存储、更新逻辑
   - 实现全量获取（一次性获取所有可转债）
   - 实现定时自动更新机制
   - 实现数据去重和更新逻辑（以代码为唯一标识）
   - 实现转股相关指标计算（如有需要）
   - 实现文件导入和远程同步功能

2. **前端实现**：
   - 参考沪深债券实时行情页面的布局
   - 实现数据概览组件：
     - 总可转债数
     - 上涨数量/下跌数量/平盘数量
     - 涨幅前五/跌幅前五
     - 成交额统计
     - 平均转股溢价率
     - 最后更新时间
   - 实现数据列表组件：
     - 支持分页（默认每页100条）
     - 支持排序（按涨跌幅、成交量、转股溢价率等）
     - 支持筛选（按名称、代码、涨跌幅范围、溢价率范围等）
     - 实时数据刷新（可配置刷新间隔：10秒、30秒、1分钟等）
     - 涨跌颜色标记（红涨绿跌）
     - 转股溢价率颜色标记
   - 实现更新数据组件：
     - 实时更新配置：
       - 刷新间隔设置
       - 自动刷新开关
     - 手动刷新按钮
   - 增加数据可视化：
     - 涨跌分布饼图
     - 溢价率分布直方图
     - 成交额TOP10柱状图
     - 价格区间分布

3. **数据模型**：
   ```python
   {
       "代码": str,  # 唯一标识，如"110044"
       "市场代码": str,  # 如"sh110044"
       "名称": str,
       "最新价": float,
       "涨跌额": float,
       "涨跌幅": float,
       "买入": float,
       "卖出": float,
       "昨收": float,
       "今开": float,
       "最高": float,
       "最低": float,
       "成交量": float,
       "成交额": float,
       "更新时间": datetime,
       "数据时间": str,  # ticktime
       "数据来源": "sina"
   }
   ```

4. **注意事项**：
   - 可转债数量相对较少（数百只），一次性获取所有数据
   - 实时数据更新频率不宜过高，建议10-30秒刷新一次
   - 需要处理市场未开市时的情况
   - 错误处理：网络异常、API限流等
   - 数据缓存：避免频繁查询数据库
   - 数据完整性：部分字段可能为空或异常值

5. **实时更新配置**：
   - 刷新间隔：10秒、30秒、1分钟、5分钟（可选）
   - 自动刷新：支持开启/关闭
   - 刷新策略：
     - 全量刷新：获取所有可转债数据
     - 仅更新变化的数据
     - 保留历史快照（可选）

6. **性能优化**：
   - 后端：使用bulk_write进行批量upsert
   - 前端：使用虚拟滚动，避免一次渲染太多数据
   - 缓存：Redis缓存最新行情数据，减少数据库查询
   - WebSocket：考虑使用WebSocket推送实时数据（可选）

### 扩展功能（可选）

1. **转股相关指标**：
   - 转股价
   - 转股价值
   - 转股溢价率
   - 纯债溢价率
   - 到期收益率

2. **行情监控**：
   - 设置涨跌幅提醒
   - 设置转股溢价率提醒
   - 支持自选可转债列表

3. **数据导出**：
   - 导出当前行情为CSV/Excel
   - 支持定时导出

4. **数据分析**：
   - 计算市场情绪指标
   - 统计溢价率分布
   - 分析涨跌幅分布
   - 计算双低策略（价格+溢价率）

5. **关联数据**：
   - 关联正股行情
   - 显示正股涨跌幅
   - 计算正股相关性

6. **图表展示**：
   - 实时K线图
   - 分时图
   - 成交量柱状图
   - 转股溢价率走势图

7. **策略筛选**：
   - 双低策略筛选器
   - 价格区间筛选
   - 溢价率区间筛选
   - 到期时间筛选

---

## ✅ 实现状态

**状态**: ✅ 已完成后端实现

**完成时间**: 2024-11-23

**实现内容**:
- ✅ 创建测试用例文件：`tests/bonds/collections/05_bond_zh_hs_cov_spot_collection.py`
- ✅ 实现数据集合测试：可转债实时数据插入、查询、索引
- ✅ **后端服务层实现**：`BondDataService.save_bond_zh_hs_cov_spot()` 和 `query_bond_zh_hs_cov_spot()`
- ✅ **数据库索引**：code唯一索引、symbol索引、changepercent索引、amount索引
- ✅ **API端点实现**：
  - `GET /api/bonds/zh-hs-cov-spot` - 查询可转债实时行情（支持搜索、分页、排序）
  - `POST /api/bonds/zh-hs-cov-spot/refresh` - 刷新可转债实时行情数据
- ⏳ 后续需要：前端页面实现

**测试运行**:
```bash
# 运行测试用例
pytest tests/bonds/collections/05_bond_zh_hs_cov_spot_collection.py -v

# 测试API（需要先启动后端服务）
# 查询实时行情
curl -X GET "http://localhost:8000/api/bonds/zh-hs-cov-spot?page=1&page_size=100&sort_by=changepercent&sort_dir=desc"

# 刷新数据
curl -X POST "http://localhost:8000/api/bonds/zh-hs-cov-spot/refresh"
```

**集合信息**:
- 集合名称：`bond_zh_hs_cov_spot`
- 唯一标识：`code`
- 数据来源：新浪财经
- API接口：`bond_zh_hs_cov_spot`

**技术实现细节**:
1. 数据模型包含15+字段：symbol、name、code、trade（最新价）、pricechange（涨跌额）、changepercent（涨跌幅）、buy、sell、open、high、low、settlement、volume、amount、ticktime
2. 使用code作为唯一标识
3. 全量获取：一次性获取所有沪深可转债的实时行情（约500-600只）
4. 支持按涨跌幅、成交额等多字段排序
5. 支持按代码、名称、symbol模糊搜索
6. 自动处理数值类型转换和空值

**数据特点**:
- 实时性：反映盘中最新价格
- 全量数据：包含所有沪深市场可转债
- 丰富字段：价格、成交、买卖盘口等完整信息
- 高频更新：交易时段可频繁刷新

**使用场景**:
1. **实时监控**：监控可转债实时价格变动
2. **涨跌榜**：查看涨幅前N、跌幅前N
3. **搜索筛选**：按代码或名称快速查找
4. **数据分析**：成交额统计、溢价率分析等

**下一步**:
- 前端页面开发（数据表格、实时更新、图表展示）
- 定时刷新任务（自动更新实时行情）
- WebSocket推送（可选，实现真正的实时更新）
- 转股溢价率计算（需要关联正股价格数据）

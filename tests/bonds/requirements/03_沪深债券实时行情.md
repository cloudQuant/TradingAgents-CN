### 背景
沪深债券实时行情数据是债券投资决策的重要参考，需要建立沪深债券实时行情数据集合。

### 任务

建立沪深债券实时行情数据集合，参考下面获取数据的API接口和字段，获取沪深债券的实时行情数据。

4. 数据唯一标识：以**代码**作为唯一标识，更新数据时，如果存在重复的代码，需要更新数据，否则需要插入数据

### 测试驱动
1. 测试用例文件：`tests/bonds/collections/03_bond_zh_hs_spot_collection.py`
2. 先写具体的测试用例，网页的测试用例可以基于selenium或者playwright来实现
3. 开发实现相应的前端和后端功能
4. 运行测试，修复测试失败的问题

### 验收标准
1. 测试用例能够全部通过
2. 手动点击没有异常情况
3. 数据能够正确获取、存储和展示
4. 页面美观、交互流畅
5. 实时更新功能能够正常运行
6. 支持涨跌幅排序和筛选

### 获取数据的API接口、字段等

#### 沪深债券实时行情

**接口**: `bond_zh_hs_spot`

**目标地址**: https://vip.stock.finance.sina.com.cn/mkt/#hs_z

**描述**: 新浪财经-债券-沪深债券-实时行情数据

**限量**: 单次返回指定页面范围内的所有沪深债券实时行情数据

**输入参数**

| 名称         | 类型  | 描述                                |
|------------|-----|-----------------------------------|
| start_page | str | start_page="1"; 开始获取的页面，每页 80 条数据 |
| end_page   | str | end_page="10"; 结束获取的页面，每页 80 条数据  |

**输出参数**

| 名称  | 类型      | 描述      |
|-----|---------|---------|
| 代码  | object  | -       |
| 名称  | object  | -       |
| 最新价 | float64 | -       |
| 涨跌额 | float64 | -       |
| 涨跌幅 | float64 | 注意单位: % |
| 买入  | float64 | -       |
| 卖出  | float64 | -       |
| 昨收  | float64 | -       |
| 今开  | float64 | -       |
| 最高  | float64 | -       |
| 最低  | float64 | -       |
| 成交量 | int64   | 注意单位: 手 |
| 成交额 | int64   | 注意单位: 万 |

**接口示例**

```python
import akshare as ak

bond_zh_hs_spot_df = ak.bond_zh_hs_spot(start_page="1", end_page="5")
print(bond_zh_hs_spot_df)
```

**数据示例**

```
      代码      名称      最新价   涨跌额  ...   最高       最低    成交量   成交额
0    sh010107   21国债⑺  100.010  0.00  ...    0.000    0.000      0        0
1    sh010303   03国债⑶  100.010  0.00  ...    0.000    0.000      0        0
2    sh010504   05国债⑷  102.396  0.05  ...  102.397  102.395  10390  1063895
3    sh010512   05国债⑿  100.050  0.00  ...    0.000    0.000      0        0
4    sh010609   06国债⑼  100.000  0.00  ...    0.000    0.000      0        0
..        ...     ...      ...   ...  ...      ...      ...    ...      ...
395  sh020418  21贴债21   99.550  0.00  ...    0.000    0.000      0        0
396  sh020419  21贴债22   99.560  0.00  ...    0.000    0.000      0        0
397  sh020420  21贴债23   99.570  0.00  ...    0.000    0.000      0        0
398  sh020421  21贴债24   99.560  0.00  ...    0.000    0.000      0        0
399  sh020422  21贴债25   99.030  0.00  ...    0.000    0.000      0        0
[400 rows x 13 columns]
```

### 实现要点

1. **后端实现**：
   - 创建或扩展 `BondDataService` 服务类
   - 实现实时行情数据获取、存储、更新逻辑
   - 实现分页批量获取（支持配置起始页和结束页）
   - 实现定时自动更新机制
   - 实现数据去重和更新逻辑（以代码为唯一标识）
   - 实现文件导入和远程同步功能

2. **前端实现**：
   - 参考股票实时行情页面的布局
   - 实现数据概览组件：
     - 总债券数
     - 上涨数量/下跌数量/平盘数量
     - 涨幅前五/跌幅前五
     - 成交额统计
     - 最后更新时间
   - 实现数据列表组件：
     - 支持分页（默认每页100条）
     - 支持排序（按涨跌幅、成交量、成交额等）
     - 支持筛选（按名称、代码、涨跌幅范围等）
     - 实时数据刷新（可配置刷新间隔：10秒、30秒、1分钟等）
     - 涨跌颜色标记（红涨绿跌）
   - 实现更新数据组件：
     - 实时更新配置：
       - 刷新间隔设置
       - 自动刷新开关
       - 页面范围配置
     - 手动刷新按钮
   - 增加数据可视化：
     - 涨跌分布饼图
     - 成交额TOP10柱状图
     - 实时行情走势图（可选）

3. **数据模型**：
   ```python
   {
       "代码": str,  # 唯一标识
       "名称": str,
       "最新价": float,
       "涨跌额": float,
       "涨跌幅": float,
       "买入": float,
       "卖出": float,
       "昨收": float,
       "今开": float,
       "最高": float,
       "最低": float,
       "成交量": int,
       "成交额": int,
       "更新时间": datetime,
       "数据来源": "sina"
   }
   ```

4. **注意事项**：
   - 实时数据更新频率不宜过高，建议10-30秒刷新一次
   - 数据量较大（可能有数千只债券），需要分页显示
   - 成交量为0的债券可能是停牌或未开市
   - 需要处理市场未开市时的情况
   - 错误处理：网络异常、API限流等
   - 数据缓存：避免频繁查询数据库

5. **实时更新配置**：
   - 刷新间隔：10秒、30秒、1分钟、5分钟（可选）
   - 自动刷新：支持开启/关闭
   - 页面范围：默认前5页（400条数据），可配置
   - 刷新策略：
     - 仅更新变化的数据
     - 保留历史快照（可选）

6. **性能优化**：
   - 后端：使用bulk_write进行批量upsert
   - 前端：使用虚拟滚动，避免一次渲染太多数据
   - 缓存：Redis缓存最新行情数据，减少数据库查询
   - WebSocket：考虑使用WebSocket推送实时数据（可选）

### 扩展功能（可选）

1. **行情监控**：
   - 设置涨跌幅提醒
   - 设置成交量异常提醒
   - 支持自选债券列表

2. **数据导出**：
   - 导出当前行情为CSV/Excel
   - 支持定时导出

3. **数据分析**：
   - 计算市场情绪指标（上涨数/总数）
   - 统计成交额分布
   - 分析涨跌幅分布

4. **历史对比**：
   - 对比当日与昨日行情
   - 查看历史快照

5. **多市场支持**：
   - 支持切换沪市/深市
   - 支持债券类型筛选（国债、企业债等）

6. **图表展示**：
   - 实时K线图
   - 分时图
   - 成交量柱状图

---

## ✅ 实现状态

**状态**: ✅ 已完成后端实现

**完成时间**: 2024-11-23

**实现内容**:
- ✅ 创建测试用例文件：`tests/bonds/collections/03_bond_zh_hs_spot_collection.py`
- ✅ 实现数据集合测试：数据插入、更新、查询、分页、排序、筛选
- ✅ 实现批量操作测试
- ✅ 实现索引创建测试
- ✅ **后端服务层实现**：`BondDataService.save_bond_zh_hs_spot()` 和 `query_bond_zh_hs_spot()`
- ✅ **数据库索引**：代码唯一索引、涨跌幅索引、成交量索引、成交额索引
- ✅ **API端点实现**：
  - `GET /api/bonds/zh-hs-spot` - 查询实时行情（支持搜索、分页、排序）
  - `POST /api/bonds/zh-hs-spot/refresh` - 刷新实时行情数据
- ⏳ 后续需要：前端页面实现

**测试运行**:
```bash
# 运行测试用例
pytest tests/bonds/collections/03_bond_zh_hs_spot_collection.py -v

# 测试API（需要先启动后端服务）
# 查询实时行情
curl -X GET "http://localhost:8000/api/bonds/zh-hs-spot?page=1&page_size=100&sort_by=涨跌幅&sort_dir=desc"

# 刷新数据
curl -X POST "http://localhost:8000/api/bonds/zh-hs-spot/refresh?start_page=1&end_page=5"
```

**集合信息**:
- 集合名称：`bond_zh_hs_spot`
- 唯一标识：`代码`
- 数据来源：新浪财经
- API接口：`bond_zh_hs_spot`

**技术实现细节**:
1. 数据模型包含13个字段：代码、名称、最新价、涨跌额、涨跌幅、买入、卖出、昨收、今开、最高、最低、成交量、成交额
2. 使用bulk_write进行批量upsert操作，性能优化
3. 支持按涨跌幅、成交量、成交额等多字段排序
4. 支持按代码或名称模糊搜索
5. 每页80条数据（AKShare接口限制），可配置起始页和结束页

**下一步**:
- 前端页面开发（数据展示、图表、实时刷新功能）
- 定时任务（自动刷新实时行情）
- WebSocket推送（可选）

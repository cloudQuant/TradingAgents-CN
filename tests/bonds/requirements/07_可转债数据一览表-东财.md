### 背景
可转债数据一览表提供了可转债的全面信息，包括申购、上市、转股价、溢价率等关键数据，是可转债投资分析的重要工具。

### 任务

建立可转债数据一览表集合，参考下面获取数据的API接口和字段，获取可转债的综合数据。

### 步骤
1. 数据集合：创建一个新的数据集合，名称为**可转债数据一览表-东财** (http://localhost:3000/bonds/collections/bond_zh_cov)
2. 页面里面需要包含数据概览、数据列表、刷新、清空数据、更新数据等功能，根据后端获取到的数据和数据列表里面的数据，增加一些基本的图形展示，让整个页面更加美观
3. 更新数据这个功能需要支持：
   - **实时更新**：支持定时自动刷新（可配置刷新间隔）
   - **全量获取**：一次性获取所有可转债数据
   - **文件导入**：支持CSV/Excel文件导入
   - **远程同步**：从其他数据库同步数据
4. 数据唯一标识：以**债券代码**作为唯一标识，更新数据时，如果存在重复的代码，需要更新数据，否则需要插入数据

### 测试驱动
1. 测试用例文件：`tests/bonds/collections/07_bond_zh_cov_collection.py`
2. 先写具体的测试用例，网页的测试用例可以基于selenium或者playwright来实现
3. 开发实现相应的前端和后端功能
4. 运行测试，修复测试失败的问题

### 验收标准
1. 测试用例能够全部通过
2. 手动点击没有异常情况
3. 数据能够正确获取、存储和展示
4. 页面美观、交互流畅
5. 支持多维度筛选和排序
6. 支持转股溢价率等关键指标的可视化展示

### 获取数据的API接口、字段等

#### 可转债数据一览表-东财

**接口**: `bond_zh_cov`

**目标地址**: https://data.eastmoney.com/kzz/default.html

**描述**: 东方财富网-数据中心-新股数据-可转债数据一览表

**限量**: 单次返回当前交易时刻的所有可转债数据

**输入参数**

| 名称  | 类型  | 描述  |
|-----|-----|-----|
| -   | -   | -   |

**输出参数**

| 名称          | 类型      | 描述       |
|-------------|---------|----------|
| 债券代码        | object  | -        |
| 债券简称        | object  | -        |
| 申购日期        | object  | -        |
| 申购代码        | object  | -        |
| 申购上限        | float64 | 注意单位: 万元 |
| 正股代码        | object  | -        |
| 正股简称        | object  | -        |
| 正股价         | float64 | -        |
| 转股价         | float64 | -        |
| 转股价值        | float64 | -        |
| 债现价         | float64 | -        |
| 转股溢价率       | float64 | 注意单位: %  |
| 原股东配售-股权登记日 | float64 | -        |
| 原股东配售-每股配售额 | object  | -        |
| 发行规模        | float64 | 注意单位: 亿元 |
| 中签号发布日      | object  | -        |
| 中签率         | float64 | 注意单位: %  |
| 上市时间        | object  | -        |
| 信用评级        | object  | -        |

**接口示例**

```python
import akshare as ak

bond_zh_cov_df = ak.bond_zh_cov()
print(bond_zh_cov_df)
```

**数据示例**

```
     债券代码   债券简称   申购日期    申购代码  ...   中签号发布日   中签率  上市时间  信用评级
0    113682   益丰转债  2024-03-04  754939  ...  2024-03-06  0.010597         NaT    AA
1    127105   龙星转债  2024-02-01  072442  ...  2024-02-05  0.005491  2024-03-06   AA-
2    123240   楚天转债  2024-01-31  370358  ...  2024-02-02  0.004307  2024-02-29    AA
3    127104   姚记转债  2024-01-25  072605  ...  2024-01-29  0.001866  2024-02-26    A+
4    123239   锋工转债  2024-01-19  370488  ...  2024-01-23  0.000734  2024-02-22    A+
..      ...    ...         ...     ...  ...         ...       ...         ...   ...
915  110227   赤化转债  2007-10-10  733227  ...  2007-10-16  0.158854  2007-10-23   AAA
916  126006  07深高债  2007-10-09  733548  ...  2007-10-15  0.290304  2007-10-30   AAA
917  110971   恒源转债  2007-09-24  733971  ...  2007-09-28  5.311774  2007-10-12   AAA
918  110567   山鹰转债  2007-09-05  733567  ...  2007-09-11  0.496391  2007-09-17    AA
919  110026   中海转债  2007-07-02  733026  ...  2007-07-06  1.333453  2007-07-12   AAA
[920 rows x 19 columns]
```

### 实现要点

1. **后端实现**：
   - 创建或扩展 `BondDataService` 服务类
   - 实现可转债一览表数据获取、存储、更新逻辑
   - 实现全量获取（一次性获取所有可转债）
   - 实现定时自动更新机制
   - 实现数据去重和更新逻辑（以债券代码为唯一标识）
   - 实现转股相关指标计算
   - 实现文件导入和远程同步功能

2. **前端实现**：
   - 参考可转债实时行情页面的布局
   - 实现数据概览组件：
     - 总可转债数
     - 已上市/未上市数量
     - 待申购/申购中数量
     - 平均转股溢价率
     - 平均中签率
     - 总发行规模
   - 实现数据列表组件：
     - 支持分页（默认每页100条）
     - 支持排序（按转股溢价率、发行规模、中签率等）
     - 支持筛选：
       - 按状态（待申购、申购中、已上市等）
       - 按转股溢价率范围
       - 按评级
       - 按发行规模
     - 状态标记（不同颜色区分状态）
     - 转股溢价率颜色标记
   - 实现更新数据组件：
     - 实时更新配置：
       - 刷新间隔设置
       - 自动刷新开关
     - 手动刷新按钮
   - 增加数据可视化：
     - 转股溢价率分布图
     - 评级分布饼图
     - 发行规模分布图
     - 申购日历（可选）

3. **数据模型**：
   ```python
   {
       "债券代码": str,  # 唯一标识
       "债券简称": str,
       "申购日期": str,
       "申购代码": str,
       "申购上限": float,  # 万元
       "正股代码": str,
       "正股简称": str,
       "正股价": float,
       "转股价": float,
       "转股价值": float,
       "债现价": float,
       "转股溢价率": float,  # %
       "股权登记日": str,
       "每股配售额": str,
       "发行规模": float,  # 亿元
       "中签号发布日": str,
       "中签率": float,  # %
       "上市时间": str,
       "信用评级": str,
       "状态": str,  # 待申购、申购中、已上市等（计算得出）
       "更新时间": datetime,
       "数据来源": "eastmoney"
   }
   ```

4. **注意事项**：
   - 数据包含历史可转债和当前可转债，需要区分状态
   - 部分字段可能为空（如未上市的债现价）
   - 实时数据更新频率不宜过高，建议30-60秒刷新一次
   - 需要根据申购日期、上市时间计算可转债状态
   - 错误处理：网络异常、API限流等
   - 数据缓存：避免频繁查询数据库

5. **状态计算逻辑**：
   - 待申购：申购日期未到
   - 申购中：在申购日期当天
   - 待上市：申购已结束但未上市
   - 已上市：已有上市时间
   - 已退市：需要额外标记

6. **性能优化**：
   - 后端：使用bulk_write进行批量upsert
   - 前端：使用虚拟滚动，避免一次渲染太多数据
   - 缓存：Redis缓存最新数据，减少数据库查询
   - 索引：在债券代码、状态、转股溢价率等字段上建立索引

### 扩展功能（可选）

1. **投资策略筛选**：
   - 双低策略（债现价+转股溢价率）
   - 价格区间筛选
   - 溢价率区间筛选
   - 到期时间筛选
   - 评级筛选

2. **申购日历**：
   - 按月份展示申购日历
   - 突出显示近期可申购的转债
   - 申购提醒功能

3. **数据导出**：
   - 导出为CSV/Excel
   - 支持选择导出字段
   - 支持按条件导出

4. **数据分析**：
   - 统计各评级的平均溢价率
   - 分析中签率分布
   - 计算发行规模统计
   - 溢价率变化趋势

5. **关联数据**：
   - 关联可转债历史行情
   - 关联正股行情
   - 关联转股价调整记录
   - 关联强赎信息

6. **提醒功能**：
   - 申购提醒
   - 上市提醒
   - 溢价率异常提醒
   - 价格到达目标提醒

7. **对比功能**：
   - 对比不同可转债的各项指标
   - 对比同发行人的不同可转债
   - 对比同评级的可转债

8. **历史追踪**：
   - 追踪溢价率变化
   - 追踪价格变化
   - 追踪中签率变化

---

## ✅ 实现状态

**状态**: ✅ 已完成后端实现

**完成时间**: 2024-11-23

**实现内容**:
- ✅ 创建测试用例文件：`tests/bonds/collections/07_bond_zh_cov_collection.py`
- ✅ 实现可转债一览表数据测试
- ✅ **后端服务层实现**：`BondDataService.save_bond_zh_cov()` 和 `query_bond_zh_cov()`
- ✅ **数据库索引**：债券代码唯一索引、债券简称索引、转股溢价率索引、上市时间索引
- ✅ **API端点实现**：
  - `GET /api/bonds/zh-cov` - 查询可转债一览表（支持搜索、分页、排序）
  - `POST /api/bonds/zh-cov/refresh` - 刷新可转债一览表数据
- ⏳ 后续需要：前端页面实现

**测试运行**:
```bash
# 运行测试用例
pytest tests/bonds/collections/07_bond_zh_cov_collection.py -v

# 测试API（需要先启动后端服务）
# 查询一览表
curl -X GET "http://localhost:8000/api/bonds/zh-cov?page=1&page_size=100&sort_by=转股溢价率&sort_dir=asc"

# 刷新数据
curl -X POST "http://localhost:8000/api/bonds/zh-cov/refresh"
```

**集合信息**:
- 集合名称：`bond_zh_cov`
- 唯一标识：`债券代码`
- 数据来源：东方财富网
- API接口：`bond_zh_cov`

**技术实现细节**:
1. 数据模型包含19个字段：债券代码、债券简称、申购日期、申购代码、申购上限、正股代码、正股简称、正股价、转股价、转股价值、债现价、转股溢价率、原股东配售相关、发行规模、中签号发布日、中签率、上市时间、信用评级
2. 使用债券代码作为唯一标识
3. 全量获取：一次性获取所有可转债数据（约900+只）
4. 支持按转股溢价率、发行规模等多字段排序
5. 支持按债券代码、债券简称、正股代码、正股简称模糊搜索
6. 自动处理数值类型转换和日期字段

**数据特点**:
- 全量数据：包含所有沪深市场可转债的完整信息
- 申购信息：申购日期、申购代码、申购上限、中签率等
- 转股指标：正股价、转股价、转股价值、转股溢价率
- 发行信息：发行规模、信用评级、上市时间
- 配售信息：原股东配售股权登记日、每股配售额

**使用场景**:
1. **可转债筛选**：按转股溢价率筛选投资标的
2. **申购分析**：查看近期可申购的可转债
3. **溢价率监控**：找出低溢价率的套利机会
4. **发行规模统计**：分析可转债市场整体规模
5. **双低策略**：筛选低价+低溢价率的可转债

**下一步**:
- 前端页面开发（数据表格、筛选功能、图表展示）
- 定时刷新任务（每日自动更新数据）
- 双低策略计算器（价格+溢价率双指标筛选）
- 申购提醒功能（即将申购的可转债提醒）

### 背景
可转债历史行情数据是可转债投资研究和技术分析的基础，需要建立可转债历史行情数据集合。

### 任务

建立可转债历史行情数据集合，参考下面获取数据的API接口和字段，获取沪深可转债的历史行情数据。

### 步骤

4. 数据唯一标识：以**可转债代码和日期**作为唯一标识，更新数据时，如果存在重复的代码和日期，需要更新数据，否则需要插入数据

### 测试驱动
1. 测试用例文件：`tests/bonds/collections/06_bond_zh_hs_cov_daily_collection.py`
2. 先写具体的测试用例，网页的测试用例可以基于selenium或者playwright来实现
3. 开发实现相应的前端和后端功能
4. 运行测试，修复测试失败的问题

### 验收标准
1. 测试用例能够全部通过
2. 手动点击没有异常情况
3. 数据能够正确获取、存储和展示
4. 页面美观、交互流畅
5. 批量更新功能能够正常运行，支持并发控制和进度显示
6. 支持K线图展示

### 获取数据的API接口、字段等

#### 可转债历史行情-日频

**接口**: `bond_zh_hs_cov_daily`

**目标地址**: https://biz.finance.sina.com.cn/suggest/lookup_n.php?q=sh110048

**描述**: 新浪财经-可转债历史行情数据，日频率更新, 新上的标的需要次日更新数据

**限量**: 单次返回具体某个沪深可转债的所有历史行情数据

**输入参数**

| 名称     | 类型  | 描述                |
|--------|-----|-------------------|
| symbol | str | symbol="sh113542" |

**输出参数**

| 名称     | 类型      | 描述  |
|--------|---------|-----|
| date   | object  | -   |
| open   | float64 | -   |
| high   | float64 | -   |
| low    | float64 | -   |
| close  | float64 | -   |
| volume | float64 | -   |

**接口示例**

```python
import akshare as ak

bond_zh_hs_cov_daily_df = ak.bond_zh_hs_cov_daily(symbol="sz128039")
print(bond_zh_hs_cov_daily_df)
```

**数据示例**

```
            date     open     high      low    close   volume
0     2018-06-29   91.470   95.200   89.400   89.500  1456563
1     2018-07-02   90.100   91.000   88.202   88.279   465913
2     2018-07-03   88.400   89.400   88.010   89.400   430800
3     2018-07-04   89.397   89.448   88.515   88.608   215772
4     2018-07-05   88.580   88.690   88.103   88.200   117494
          ...      ...      ...      ...      ...      ...
1370  2024-02-22  108.000  108.555  107.901  108.200   182005
1371  2024-02-23  108.200  109.296  107.600  107.800   125660
1372  2024-02-26  107.800  108.254  107.555  108.099   118131
1373  2024-02-27  107.980  108.222  107.672  107.800    81086
1374  2024-02-28  107.878  108.106  105.847  105.980   149757
[1375 rows x 6 columns]
```

### 实现要点

1. **后端实现**：
   - 扩展 `BondDataService` 服务类
   - 实现可转债历史行情数据获取、存储、更新逻辑
   - 实现批量获取（从可转债实时行情或列表获取代码）
   - 实现增量更新（只更新最近N天的数据）
   - 实现并发控制（避免API限流）
   - 实现文件导入和远程同步功能

2. **前端实现**：
   - 参考债券历史行情页面的布局
   - 实现数据概览组件：
     - 总记录数
     - 覆盖可转债数
     - 最早/最新日期
     - 数据覆盖天数
   - 实现数据列表组件：
     - 支持分页（默认每页100条）
     - 支持排序（按日期、成交量等）
     - 支持筛选（按债券代码、日期范围等）
     - 支持K线图展示（可选）
   - 实现更新数据组件：
     - 文件导入
     - 远程同步
     - 批量更新配置：
       - 债券代码列表（从其他集合获取或手动输入）
       - 批量大小、并发数、延迟时间
     - 单个更新：
       - 输入债券代码
     - 增量更新：只更新最近N天
   - 增加数据可视化：
     - K线图（选中某只可转债查看）
     - 成交量图
     - 价格走势图

3. **数据模型**：
   ```python
   {
       "债券代码": str,  # 联合主键，如"sz128039"
       "日期": str,      # 联合主键
       "开盘": float,
       "收盘": float,
       "最高": float,
       "最低": float,
       "成交量": float,
       "更新时间": datetime,
       "数据来源": "sina"
   }
   ```

4. **注意事项**：
   - 可转债历史数据通常比普通债券短（多数在5年以内）
   - 新上市的可转债需要次日才能获取数据
   - 需要合理规划数据更新策略：
     - 首次导入：获取全部历史数据
     - 增量更新：只更新最近几天的数据
   - API调用频率控制：建议每次请求间隔0.5-1秒
   - 批量更新时需要显示详细进度（当前债券、进度百分比、预计剩余时间）
   - 错误处理：网络异常、API限流、数据格式异常、停牌债券、退市债券等
   - 数据验证：检查日期连续性、价格合理性等
   - 索引优化：在债券代码、日期字段上建立联合索引

5. **批量更新配置**：
   - 批量大小：建议10-50只可转债为一批
   - 并发数：建议1-2（避免被限流）
   - 延迟时间：建议0.5-1秒/次
   - 更新策略：
     - 全量更新：获取可转债的全部历史数据
     - 增量更新：只更新最近5-10个交易日

6. **性能优化**：
   - 后端：使用bulk_write进行批量upsert
   - 前端：使用虚拟列表或分页，避免一次渲染太多数据
   - 缓存：可以考虑缓存常用可转债的历史数据
   - 分表：如果数据量特别大，可以考虑按年份分表

### 扩展功能（可选）

1. **K线图展示**：
   - 集成ECharts或TradingView
   - 支持日K、周K、月K切换
   - 支持技术指标叠加（MA、MACD、KDJ等）
   - 支持缩放、拖动

2. **数据分析**：
   - 计算技术指标（移动平均线、布林带等）
   - 统计价格波动率
   - 计算收益率
   - 分析成交量变化

3. **数据导出**：
   - 导出为CSV/Excel
   - 支持选择导出字段
   - 支持按条件导出（如：某只可转债、某个时间段）

4. **数据质量检查**：
   - 检查数据缺失（交易日缺失）
   - 检查数据异常（价格突变、成交量异常等）
   - 生成数据质量报告

5. **定时任务**：
   - 每日收盘后自动更新最新数据
   - 支持配置定时任务时间和范围

6. **数据对比**：
   - 对比不同可转债的历史走势
   - 对比可转债与正股的走势
   - 对比可转债与指数的走势

7. **回测功能**：
   - 基于历史数据进行简单回测
   - 计算持有期收益率
   - 测试双低策略

8. **转股相关分析**：
   - 关联转股价历史数据
   - 计算历史转股溢价率
   - 分析溢价率变化趋势

9. **价格区间分析**：
   - 统计价格在不同区间的天数
   - 分析价格分布特征
   - 计算价格百分位数

---

## ✅ 实现状态

**状态**: ✅ 已完成后端实现

**完成时间**: 2024-11-23

**实现内容**:
- ✅ 创建测试用例文件：`tests/bonds/collections/06_bond_zh_hs_cov_daily_collection.py`
- ✅ 实现数据集合测试：可转债历史数据插入、查询、联合索引
- ✅ **后端服务层实现**：`BondDataService.save_bond_zh_hs_cov_daily()` 和 `query_bond_zh_hs_cov_daily()`
- ✅ **数据库索引**：symbol+date联合唯一索引、symbol索引、date索引
- ✅ **API端点实现**：
  - `GET /api/bonds/zh-hs-cov-daily/{symbol}` - 查询指定可转债历史行情（支持日期范围、分页）
  - `POST /api/bonds/zh-hs-cov-daily/{symbol}/refresh` - 刷新单个可转债历史数据
  - `POST /api/bonds/zh-hs-cov-daily/batch-refresh` - 批量刷新多个可转债历史数据
- ⏳ 后续需要：前端页面实现

**测试运行**:
```bash
# 运行测试用例
pytest tests/bonds/collections/06_bond_zh_hs_cov_daily_collection.py -v

# 测试API（需要先启动后端服务）
# 查询历史行情
curl -X GET "http://localhost:8000/api/bonds/zh-hs-cov-daily/sz128039?start_date=2024-01-01&page=1&page_size=100"

# 刷新单个可转债
curl -X POST "http://localhost:8000/api/bonds/zh-hs-cov-daily/sz128039/refresh"

# 批量刷新
curl -X POST "http://localhost:8000/api/bonds/zh-hs-cov-daily/batch-refresh?symbols=sz128039&symbols=sh113542"
```

**集合信息**:
- 集合名称：`bond_zh_hs_cov_daily`
- 唯一标识：`symbol` + `date` （联合主键）
- 数据来源：新浪财经
- API接口：`bond_zh_hs_cov_daily`

**技术实现细节**:
1. 数据模型包含7个字段：symbol（可转债代码）、date（日期）、open（开盘）、high（最高）、low（最低）、close（收盘）、volume（成交量）
2. 使用联合主键（symbol+date）确保数据唯一性
3. 支持按日期范围查询，默认按日期倒序
4. 批量刷新接口包含API限流保护（0.5秒间隔）
5. 全量获取：每次调用AKShare接口获取可转债的全部历史数据
6. 增量更新：通过upsert操作自动处理新增和更新
7. 数据覆盖：从上市日起至最新交易日（可能有1000+条记录）

**使用场景**:
1. **单转债查询**：查看某个可转债的历史走势
2. **日期范围查询**：分析特定时间段的价格变化
3. **批量更新**：一次性更新多个可转债的历史数据
4. **K线图展示**：为前端提供OHLC数据
5. **技术分析**：计算均线、MACD等技术指标

**数据特点**:
- 高质量：新浪财经官方数据，准确性高
- 完整性：从上市日开始的完整历史数据
- 日频更新：每日收盘后更新当日数据
- 长周期：部分转债有数年的历史数据

**下一步**:
- 前端页面开发（K线图、历史数据表格、图表展示）
- 定时任务（每日自动更新历史数据）
- 增量更新优化（只更新最近N天的数据）
- 技术指标计算（MA、MACD、RSI等）

# 债券信息批量更新功能说明

## 功能概述

在债券信息查询（`bond_info_cm`）数据集合中，新增了"更新全部年份"按钮，可以一键批量更新从1993年到当前年份的所有债券数据。

## 功能特性

### 1. 批量更新
- **年份范围**: 自动从1993年更新到当前年份
- **并发线程**: 使用10个并发线程同时更新，大幅提升更新效率
- **智能分批**: 将所有年份分批处理，每批最多10个并发任务

### 2. 参数保留
批量更新时会保留以下已设置的查询参数：
- 债券类型
- 付息方式
- 评级
- 债券名称
- 债券代码
- 发行人
- 承销商

**仅发行年份参数会被自动设置为1993-当前年份逐年更新。**

### 3. 进度跟踪
- 实时显示更新进度
- 显示已完成/总数
- 显示失败数量
- 使用进度条可视化展示

## 使用方法

### 步骤1: 打开数据集合
1. 访问：债券投研 → 数据集合
2. 点击"债券信息查询"集合

### 步骤2: 打开更新对话框
点击页面右上角的"更新数据"按钮

### 步骤3: 设置可选参数（可选）
如果只想更新特定类型的债券，可以设置以下参数：
- **债券类型**: 短期融资券、中期票据、企业债等
- **付息方式**: 零息式、固定利率、浮动利率
- **评级**: AAA+、AAA、AA+等
- **其他**: 债券名称、代码、发行人、承销商等

**注意**: 不要设置"发行年份"参数，批量更新会自动处理所有年份。

### 步骤4: 开始批量更新
1. 点击对话框底部的"更新全部年份"按钮
2. 确认操作（系统会提示将更新的年份数量）
3. 等待更新完成

## 技术实现

### 前端实现
**文件**: `frontend/src/views/Bonds/Collection.vue`

**核心功能**:
```typescript
// 批量更新函数
const refreshAllYears = async () => {
  // 1. 生成1993-当前年份列表
  const years = Array.from(
    { length: currentYear - 1993 + 1 }, 
    (_, i) => (1993 + i).toString()
  )
  
  // 2. 使用10个并发线程分批处理
  const concurrency = 10
  for (let i = 0; i < years.length; i += concurrency) {
    const batch = years.slice(i, i + concurrency)
    await Promise.all(batch.map(year => updateYear(year)))
  }
}
```

**状态变量**:
- `batchRefreshing`: 批量更新状态
- `batchProgress`: 进度信息 `{ completed, total, failed }`
- `batchTasks`: 任务列表

### 后端支持
使用现有的 `/api/bonds/collections/{collection_name}/refresh` API，为每个年份创建独立的刷新任务。

## 预期效果

### 更新时间估算
- **总年份数**: 2025年 - 1993年 + 1 = 33个年份
- **并发线程**: 10个
- **预计批次**: 4批（33 ÷ 10 ≈ 4）
- **预计时间**: 视网络和数据量而定，通常需要数分钟到十几分钟

### 进度显示示例
```
批量更新进行中
正在使用10个并发线程更新数据，请耐心等待...

[=========>      ] 58%

已完成: 19 / 33 个年份（失败: 0）
```

### 完成提示
- ✅ 成功: "批量更新完成！成功更新 33 个年份的数据"
- ⚠️ 部分失败: "批量更新完成！成功 30 个，失败 3 个"

## 注意事项

### 1. 网络要求
- 需要稳定的网络连接
- 更新过程中请勿关闭浏览器
- 建议在网络较好的环境下执行

### 2. 时间要求
- 批量更新需要较长时间
- 建议在非高峰时段执行
- 不要同时执行多个批量更新任务

### 3. 数据要求
- 数据来源：中国外汇交易中心
- 数据会自动去重
- 如有重复数据会自动更新

### 4. 错误处理
- 单个年份失败不会影响其他年份
- 失败的年份会在进度中显示
- 可以查看浏览器控制台了解详细错误信息

## 常见问题

### Q1: 为什么从1993年开始？
A: 1993年是中国债券市场正式启动的年份，更早的数据通常不可用或不完整。

### Q2: 可以修改并发线程数吗？
A: 可以，修改代码中的 `concurrency` 变量即可。建议值为5-15之间。

### Q3: 更新会覆盖现有数据吗？
A: 是的，相同债券的数据会被更新，这是为了获取最新的准确信息。

### Q4: 可以中断批量更新吗？
A: 可以，点击"取消"按钮即可中断。已创建的任务可能会继续执行完成。

### Q5: 失败的年份怎么办？
A: 可以单独为失败的年份手动设置"发行年份"参数后点击"开始更新"重试。

## 更新日志

### 2025-11-16
- ✨ 新增"更新全部年份"功能
- ✨ 支持10个并发线程批量更新
- ✨ 添加批量更新进度显示
- ✨ 添加失败统计和提示

## 相关文件

- **前端页面**: `frontend/src/views/Bonds/Collection.vue`
- **后端API**: `app/routers/bonds.py` - `/api/bonds/collections/{collection_name}/refresh`
- **数据服务**: `app/services/collection_refresh_service.py`

## 技术支持

如遇问题，请查看：
1. 浏览器控制台的错误信息
2. 后端日志
3. 任务管理器中的任务状态

---

**提示**: 首次使用建议先测试少量年份（可手动设置几个年份测试），确认无误后再执行全量更新。

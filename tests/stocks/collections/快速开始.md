# 🚀 快速开始指南

## 问题已解决 ✅

**原问题**：前端页面显示91个集合，但测试获取不到数据

**解决方案**：测试现在支持3种方式智能获取数据，自动选择可用的方式

---

## 第一步：诊断环境

运行诊断工具，检查哪些方式可用：

```bash
cd f:\source_code\TradingAgents-CN\tests\stocks\collections
python diagnose_api_access.py
```

**输出示例**：
```
🔍 API访问诊断工具
================================================================================
说明: 测试会尝试2种方式获取集合列表数据
      只要有一种方式成功，测试就能正常运行
================================================================================

方式1: 后端API直连
URL: http://localhost:8000/api/stocks/collections
✓ HTTP状态: 200
✓ Content-Type: application/json
✓ ✅ 成功！返回 91 个集合
✓ 示例集合: ['沪深京A股', '上证A股', '深证A股']

方式2: Playwright页面DOM提取
URL: http://localhost:3000/stocks/collections
✗ Playwright未安装
  提示: 运行 pip install playwright && playwright install chromium

📊 诊断结果总结
================================================================================
✅ 可用 后端API直连 （91个集合）
❌ 不可用 Playwright DOM提取
================================================================================

✅ 有1种方式可用：后端API直连

测试可以正常运行！
```

---

## 第二步：运行测试

只要有**任意一种方式**可用，测试就能正常运行：

```bash
cd f:\source_code\TradingAgents-CN\tests\stocks
pytest .\collections\test_collections_requirements_coverage.py -v -s
```

---

## 安装选项

### 基础安装（推荐）
```bash
# 支持方式1和方式2（API请求）
pip install httpx pytest
```

### 完整安装（可选）
```bash
# 额外支持方式3（浏览器自动化）
pip install playwright
playwright install chromium
```

**说明**：
- 基础安装足够应对大多数情况
- 完整安装提供最可靠的备选方案（~200MB）

---

## 测试输出

### 成功获取数据（方式1：后端API）
```
正在获取集合列表...
  方式1: 尝试后端API http://localhost:8000/api/stocks/collections
  ✓ 后端API成功返回 91 个集合

【前端API返回结果】
  前端API返回 91 个数据集合
================================================================================

【验证结果统计】
  ✓ 已实现的集合: 91 个
  ✗ 缺失的集合:   274 个
  覆盖率: 91/365 (24%)
```

### 使用Playwright备选方案（方式2：DOM提取）
```
正在获取集合列表...
  方式1: 尝试后端API http://localhost:8000/api/stocks/collections
  ✗ 后端API需要认证（401）
  方式2: 尝试从前端页面DOM提取数据（使用Playwright）
    启动浏览器...
    访问页面: http://localhost:3000/stocks/collections
    等待数据加载...
    ✓ 从页面DOM提取到 91 个集合

【前端API返回结果】
  前端API返回 91 个数据集合
```

---

## 常见问题

### Q1: 所有方式都失败了怎么办？

**诊断步骤**：

1. **确认服务运行**
   ```bash
   # 前端（Vite/Vue）
   npm run dev  # 应该在 http://localhost:3000
   
   # 后端（FastAPI）
   python main.py  # 应该在 http://localhost:8000
   ```

2. **浏览器测试**
   - 打开 http://localhost:3000/stocks/collections
   - 检查页面是否正常显示集合列表
   - 打开浏览器开发者工具（F12）
   - 查看 Network 标签，找到获取集合的API请求

3. **检查认证**
   ```bash
   # 如果API需要认证
   $env:TEST_AUTH_TOKEN="your-token-here"
   ```

### Q2: 如何查看详细日志？

每次测试都会生成日志文件：
```
tests/stocks/test_coverage_report_YYYYMMDD_HHMMSS.log
```

查看最新日志：
```bash
cd f:\source_code\TradingAgents-CN\tests\stocks
python view_latest_report.py
```

### Q3: 能否跳过某种方式？

可以，修改测试代码注释掉不需要的方式。但建议保留所有方式以提高成功率。

### Q4: Playwright很慢，如何优化？

Playwright是备选方案，只在API方式失败时才使用。如果API可用，不会启动浏览器。

---

## 测试覆盖率解读

```
【验证结果统计】
  ✓ 已实现的集合: 91 个        ← 后端/前端已实现的集合数
  ✗ 缺失的集合:   274 个       ← 需求文档中有但未实现的
  覆盖率: 91/365 (24%)         ← 实现进度
```

**下一步**：
- 查看日志文件了解哪些集合缺失
- 在后端 `app/routers/stocks.py` 中添加这些集合

---

## 技术支持

### 相关文档
- `README_多方式数据获取.md` - 技术细节
- `CHANGELOG.md` - 版本历史
- 日志文件 - 详细执行记录

### 诊断工具
- `diagnose_api_access.py` - 环境诊断
- `quick_check.py` - 快速覆盖率检查
- `check_coverage_summary.py` - 覆盖率摘要

---

## 版本信息

- **当前版本**: v4.0
- **更新日期**: 2024-11-23
- **主要特性**: 多方式智能获取 + Playwright备选方案

---

**🎉 现在开始测试吧！**

```bash
# 1. 诊断环境
python diagnose_api_access.py

# 2. 运行测试
cd ..
pytest .\collections\test_collections_requirements_coverage.py -v -s
```

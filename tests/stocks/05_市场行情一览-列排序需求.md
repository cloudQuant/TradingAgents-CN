# 市场行情一览 - 列排序需求（TDD）

> 版本：v1.0  
> 范围：`/stocks/overview` 页面中的“市场行情一览”模块  
> 目标：在现有“分页 + 搜索 + 真实数据”的基础上，**为表格的主要数值列增加可点击排序能力**。

---

## 1. 背景与现状

当前“市场行情一览”已具备能力：

- 数据来源：后端接口 `GET /api/stocks/quotes/overview`
- 支持分页：`page` / `page_size`，前端每页 20 条
- 支持搜索：`keyword`（代码/名称模糊）
- 默认排序：按 `amount desc`

缺失能力：

- 前端表格列头不可点击，用户无法直接按“涨跌幅、成交量、成交额”等字段排序。

本需求即在 **不破坏现有接口设计** 的前提下，通过前后端配合，实现“列点击排序”。

---

## 2. 总体设计

### 2.1 需要支持排序的字段

在“市场行情一览”表格中，支持排序的列：

1. 代码 `code`
2. 名称 `name`（前端本地按字符串排序，不依赖后端字段）
3. 最新价 `latest_price`（后端字段 `close`）
4. 涨跌幅 `pct_chg`
5. 成交量 `volume`
6. 成交额 `amount`
7. 交易日期 `trade_date`

> 说明：
> - 后端当前允许的排序字段集合为：`{"amount", "volume", "pct_chg", "close", "trade_date", "updated_at"}`。
> - `code` / `name` 字段排序可以优先使用前端本地排序（如有需要再扩展后端）。

### 2.2 排序参数与请求约定

沿用 `/api/stocks/quotes/overview` 中的既有参数：

- `sort_by`: string
- `sort_dir`: `asc | desc`

约定映射关系：

- 表格列 → 接口 `sort_by`：
  - 代码列：**前端本地排序**，不传 `sort_by`（或保持上一次）
  - 最新价列：`sort_by = "close"`
  - 涨跌幅列：`sort_by = "pct_chg"`
  - 成交量列：`sort_by = "volume"`
  - 成交额列：`sort_by = "amount"`
  - 交易日期列：`sort_by = "trade_date"`

排序方向：

- 每次点击同一列表头：`none -> desc -> asc -> desc -> ...`
- 初始状态：保持当前默认 `sort_by = "amount"`, `sort_dir = "desc"`。

分页与搜索：

- 排序应与分页、搜索联动：
  - 排序改变时，页码重置为 `1`；
  - 接口总是带上当前的 `keyword` 与 `sort_by` / `sort_dir`。

---

## 3. 后端兼容性与测试需求

> 注：后端接口 `get_quotes_overview` 已支持 `sort_by` / `sort_dir`，本需求 **不改接口签名**，仅通过测试验证排序行为符合预期。

### 3.1 行为要求

1. 当传入不同合法 `sort_by` 时：
   - 不抛异常，正常返回数据；
   - 当前页 `items` 应按指定字段和方向排序（在数据量足够的前提下）。

2. 当传入非法 `sort_by` 值时：
   - 后端自动回退到默认字段（`amount`），不报 500。

3. `sort_dir` 仅接受 `asc` / `desc`：
   - 其他值视为 `desc`（保持当前实现）。

### 3.2 TDD：测试点设计

在 `tests/stocks/collections/test_quotes_overview_api.py` 中扩展：

1. **存在性测试（保持已有）**
   - 已验证接口在 `page=1&page_size=20` 时返回 200 或 401。

2. **排序字段兼容性测试（无 Token 环境也可）**

   新增测试：

   - [ ] `test_overview_sort_by_supported_fields`：
     - 针对 `sort_by` in `["amount", "volume", "pct_chg", "close", "trade_date", "updated_at"]`
     - 循环请求：`/api/stocks/quotes/overview?page=1&page_size=5&sort_by=xxx&sort_dir=desc`
     - 断言：`status_code in [200, 401]`，接口不报错。

3. **排序结果基本正确性（仅在有 Token 时执行）**

   在有 `TEST_AUTH_TOKEN` 时新增/扩展测试：

   - [ ] `test_overview_sort_result_if_authorized`：
     - 使用 `sort_by="amount"`, `sort_dir="desc"` 请求 1 页，`page_size=10`；
     - 若返回的 `items` 数量 ≥ 2，则断言 `items[i].amount >= items[i+1].amount`；
   - [ ] 可选：对 `volume` / `pct_chg` 做类似检查。

> 对于无 Token 环境：
> - 仅保留“接口不报错”的验证，不强制检查排序结果。

---

## 4. 前端交互需求

### 4.1 列头排序 UI

在 `Stocks/index.vue` 的“市场行情一览”表格中：

- 为以下列开启排序指示与点击事件：
  - 最新价
  - 涨跌幅
  - 成交量
  - 成交额
  - 交易日期（如在表格中展示）

实现方式（Element Plus 标准用法）：

- 使用 `:default-sort` 和 `sortable="custom"`；
- 监听 `@sort-change` 事件，在事件回调中：
  - 将 `sort_by` / `sort_dir` 写入本地状态；
  - 将 `page` 重置为 1；
  - 调用 `loadQuotes()` 重新请求。

组件新增状态：

- `sortBy`: string | undefined
- `sortDir`: 'asc' | 'desc' | ''

### 4.2 状态与请求参数

当前 `loadQuotes()` 参数基础上扩展：

- 请求时附带：

```ts
stocksApi.getQuotesOverview({
  page: page.value,
  page_size: pageSize.value,
  keyword: keyword.value || undefined,
  sort_by: sortBy.value || undefined,
  sort_dir: sortDir.value || undefined,
})
```

- 初始状态：
  - `sortBy = 'amount'`
  - `sortDir = 'desc'`
  - 与后端默认保持一致，避免首屏排序状态不一致。

### 4.3 排序与分页/搜索的联动

1. 点击列头更改排序：
   - `page` 重置为 1；
   - 保持当前 `keyword`；
   - 触发 `loadQuotes()`。

2. 搜索时：
   - 保留当前排序字段与方向不变；
   - 只将 `page` 重置为 1。

3. 分页时：
   - 保留当前排序与搜索条件不变；
   - 只更新 `page`，重新请求当前排序下的下一页数据。

---

## 5. 验收标准

1. 打开 `/stocks/overview`：
   - [ ] “市场行情一览”表格右上角仍有搜索框 + 查询按钮；
   - [ ] 默认按“成交额降序”展示；
   - [ ] 表头可见排序图标（至少在 Element Plus 的 hover/点击状态下明显可见）。

2. 列排序行为：
   - [ ] 点击“成交额”列表头，数据按成交额降序排列，再次点击切为升序；
   - [ ] 点击“成交量”列表头，数据按成交量排序（原排序状态清除或更新为新的字段）；
   - [ ] 在排序状态下翻页，排序顺序保持一致。

3. 搜索联动：
   - [ ] 在某个排序下输入关键字搜索，结果范围收窄，但当前排序方向不变；
   - [ ] 搜索后点击其他列头，排序字段切换、方向依规则变化。

4. 回归：
   - [ ] 所有已有功能保持可用：分页、搜索、点击代码/名称跳转详情页；
   - [ ] 浏览器控制台无未处理的前端错误日志。

---

## 6. 开发顺序（TDD）

1. **测试 / 后端验证**：
   - 在 `test_quotes_overview_api.py` 中新增排序字段兼容性测试；
   - 如有 Token，则补充排序结果正确性的基础断言。

2. **前端实现**：
   - 在 `Stocks/index.vue` 中新增 `sortBy` / `sortDir` 状态及 `sort-change` 事件处理；
   - 将排序参数透传给 `stocksApi.getQuotesOverview`。

3. **联调与验收**：
   - 按本需求文档第 5 节逐项手工验收；
   - 若后续发现排序字段集合需要调整，再迭代更新。

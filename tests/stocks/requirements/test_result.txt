/Users/yunjinqi/opt/anaconda3/lib/python3.11/site-packages/pytest_asyncio/plugin.py:211: PytestDeprecationWarning: The configuration option "asyncio_default_fixture_loop_scope" is unset.
The event loop scope for asynchronous fixtures will default to the fixture caching scope. Future versions of pytest-asyncio will default the loop scope for asynchronous fixtures to function scope. Set the default fixture loop scope explicitly in order to avoid unexpected behavior in the future. Valid fixture loop scopes are: "function", "class", "module", "package", "session"

  warnings.warn(PytestDeprecationWarning(_DEFAULT_FIXTURE_LOOP_SCOPE_UNSET))
============================= test session starts ==============================
platform darwin -- Python 3.11.8, pytest-8.3.0, pluggy-1.5.0
benchmark: 5.1.0 (defaults: timer=time.perf_counter disable_gc=False min_rounds=5 min_time=0.000005 max_time=1.0 calibration_precision=10 warmup=False warmup_iterations=100000)
rootdir: /Users/yunjinqi/Documents/TradingAgents-CN/tests
configfile: pytest.ini
plugins: Faker-37.5.3, anyio-4.11.0, flask-1.3.0, html-4.1.1, asyncio-1.1.0, xdist-3.8.0, time-machine-2.16.0, timeout-2.4.0, metadata-3.1.1, rerunfailures-14.0, cov-6.2.1, playwright-0.7.0, mock-3.14.1, ordering-0.6, sugar-1.1.1, benchmark-5.1.0, langsmith-0.4.38, base-url-2.1.0, dash-2.18.2, picked-0.5.1, requests-mock-1.12.1
asyncio: mode=Mode.STRICT, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 2 items

../../funds/test_fund_rating_all_em.py FF                                [100%]

=================================== FAILURES ===================================
____ TestFundRatingAllEmBackend.test_save_and_clear_fund_rating_all_em_data ____

self = <test_fund_rating_all_em.TestFundRatingAllEmBackend object at 0x133753210>

    @pytest.mark.asyncio
    async def test_save_and_clear_fund_rating_all_em_data(self):
        """æµ‹è¯•ä¿å­˜å’Œæ¸…ç©ºåŸºé‡‘è¯„çº§æ€»æ±‡"""
        from app.services.fund_data_service import FundDataService
        from app.core.database import init_database, close_database, get_mongo_db
    
>       await init_database()

../../funds/test_fund_rating_all_em.py:23: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../../../app/core/database.py:200: in init_database
    await db_manager.init_redis()
../../../app/core/database.py:93: in init_redis
    await self.redis_client.ping()
../../../../../opt/anaconda3/lib/python3.11/site-packages/redis/asyncio/client.py:720: in execute_command
    conn = self.connection or await pool.get_connection()
../../../../../opt/anaconda3/lib/python3.11/site-packages/redis/asyncio/connection.py:1198: in get_connection
    await self.ensure_connection(connection)
../../../../../opt/anaconda3/lib/python3.11/site-packages/redis/asyncio/connection.py:1231: in ensure_connection
    await connection.connect()
../../../../../opt/anaconda3/lib/python3.11/site-packages/redis/asyncio/connection.py:298: in connect
    await self.connect_check_health(check_health=True)
../../../../../opt/anaconda3/lib/python3.11/site-packages/redis/asyncio/connection.py:324: in connect_check_health
    await self.on_connect_check_health(check_health=check_health)
../../../../../opt/anaconda3/lib/python3.11/site-packages/redis/asyncio/connection.py:471: in on_connect_check_health
    await self.read_response()
../../../../../opt/anaconda3/lib/python3.11/site-packages/redis/asyncio/connection.py:599: in read_response
    response = await self._parser.read_response(
../../../../../opt/anaconda3/lib/python3.11/site-packages/redis/_parsers/resp2.py:82: in read_response
    response = await self._read_response(disable_decoding=disable_decoding)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <redis._parsers.resp2._AsyncRESP2Parser object at 0x13bc71a50>
disable_decoding = False

    async def _read_response(
        self, disable_decoding: bool = False
    ) -> Union[EncodableT, ResponseError, None]:
        raw = await self._readline()
        response: Any
        byte, response = raw[:1], raw[1:]
    
        # server returned an error
        if byte == b"-":
            response = response.decode("utf-8", errors="replace")
            error = self.parse_error(response)
            # if the error is a ConnectionError, raise immediately so the user
            # is notified
            if isinstance(error, ConnectionError):
                self._clear()  # Successful parse
>               raise error
E               redis.exceptions.AuthenticationError: Authentication required.

../../../../../opt/anaconda3/lib/python3.11/site-packages/redis/_parsers/resp2.py:102: AuthenticationError
------------------------------ Captured log call -------------------------------
ERROR    app.core.database:database.py:100 âŒ Redisè¿æ¥å¤±è´¥: Authentication required.
ERROR    app.core.database:database.py:207 ğŸ’¥ æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥: Authentication required.
_______________ TestFundRatingAllEmAPI.test_collection_endpoints _______________

self = <test_fund_rating_all_em.TestFundRatingAllEmAPI object at 0x1337647d0>

    @pytest.mark.asyncio
    async def test_collection_endpoints(self):
        """æµ‹è¯•åŸºé‡‘è¯„çº§æ€»æ±‡é›†åˆç«¯ç‚¹"""
        from app.main import app
        from app.core.database import init_database, close_database
    
>       await init_database()

../../funds/test_fund_rating_all_em.py:81: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../../../app/core/database.py:200: in init_database
    await db_manager.init_redis()
../../../app/core/database.py:93: in init_redis
    await self.redis_client.ping()
../../../../../opt/anaconda3/lib/python3.11/site-packages/redis/asyncio/client.py:720: in execute_command
    conn = self.connection or await pool.get_connection()
../../../../../opt/anaconda3/lib/python3.11/site-packages/redis/asyncio/connection.py:1198: in get_connection
    await self.ensure_connection(connection)
../../../../../opt/anaconda3/lib/python3.11/site-packages/redis/asyncio/connection.py:1231: in ensure_connection
    await connection.connect()
../../../../../opt/anaconda3/lib/python3.11/site-packages/redis/asyncio/connection.py:298: in connect
    await self.connect_check_health(check_health=True)
../../../../../opt/anaconda3/lib/python3.11/site-packages/redis/asyncio/connection.py:324: in connect_check_health
    await self.on_connect_check_health(check_health=check_health)
../../../../../opt/anaconda3/lib/python3.11/site-packages/redis/asyncio/connection.py:471: in on_connect_check_health
    await self.read_response()
../../../../../opt/anaconda3/lib/python3.11/site-packages/redis/asyncio/connection.py:599: in read_response
    response = await self._parser.read_response(
../../../../../opt/anaconda3/lib/python3.11/site-packages/redis/_parsers/resp2.py:82: in read_response
    response = await self._read_response(disable_decoding=disable_decoding)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <redis._parsers.resp2._AsyncRESP2Parser object at 0x13bc71350>
disable_decoding = False

    async def _read_response(
        self, disable_decoding: bool = False
    ) -> Union[EncodableT, ResponseError, None]:
        raw = await self._readline()
        response: Any
        byte, response = raw[:1], raw[1:]
    
        # server returned an error
        if byte == b"-":
            response = response.decode("utf-8", errors="replace")
            error = self.parse_error(response)
            # if the error is a ConnectionError, raise immediately so the user
            # is notified
            if isinstance(error, ConnectionError):
                self._clear()  # Successful parse
>               raise error
E               redis.exceptions.AuthenticationError: Authentication required.

../../../../../opt/anaconda3/lib/python3.11/site-packages/redis/_parsers/resp2.py:102: AuthenticationError
----------------------------- Captured stdout call -----------------------------
2025-11-23 12:29:05,338 | agents               | INFO     | ğŸ” [ConfigManager] åŠ è½½ .env æ–‡ä»¶: /Users/yunjinqi/Documents/TradingAgents-CN/.env
2025-11-23 12:29:05,338 | agents               | INFO     | ğŸ” [ConfigManager] åŠ è½½å‰ DASHSCOPE_API_KEY: ç©º
2025-11-23 12:29:05,341 | agents               | INFO     | ğŸ” [ConfigManager] åŠ è½½å DASHSCOPE_API_KEY: æœ‰å€¼
2025-11-23 12:29:05,341 | agents               | INFO     | ğŸ”§ [ConfigManager] å¼€å§‹åˆå§‹åŒ– MongoDB å­˜å‚¨...
2025-11-23 12:29:05,341 | agents               | INFO     | ğŸ” [ConfigManager] USE_MONGODB_STORAGE=false (è§£æä¸º: False)
2025-11-23 12:29:05,341 | agents               | INFO     | â„¹ï¸ [ConfigManager] MongoDB å­˜å‚¨æœªå¯ç”¨ï¼Œå°†ä½¿ç”¨ JSON æ–‡ä»¶å­˜å‚¨
2025-11-23 12:29:05,354 | tradingagents.init   | INFO     | ğŸš€ TradingAgents-CN æ—¥å¿—ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ
2025-11-23 12:29:05,354 | tradingagents.init   | INFO     | ğŸ“ æ—¥å¿—ç›®å½•: ./logs
2025-11-23 12:29:05,354 | tradingagents.init   | INFO     | ğŸ“Š æ—¥å¿—çº§åˆ«: INFO
2025-11-23 12:29:08,553 | tradingagents.init   | INFO     | ğŸš€ TradingAgents-CN æ—¥å¿—ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ
2025-11-23 12:29:08,553 | tradingagents.init   | INFO     | ğŸ“ æ—¥å¿—ç›®å½•: ./logs
2025-11-23 12:29:08,553 | tradingagents.init   | INFO     | ğŸ“Š æ—¥å¿—çº§åˆ«: INFO
2025-11-23 12:29:08,591 | tradingagents.config | INFO     | [runtime_settings] TA_USE_APP_CACHE evaluated -> False (source=default, env=None)
2025-11-23 12:29:08,598 | dataflows            | INFO     | âœ… [æ•°æ®æºé…ç½®] ä»æ•°æ®åº“è¯»å–åˆ°å·²å¯ç”¨çš„æ•°æ®æº: {'yahoo_finance', 'tushare', 'finnhub', 'akshare', 'baostock', 'alpha_vantage'}
2025-11-23 12:29:08,599 | dataflows            | WARNING  | âš ï¸ Tushareæ•°æ®æºä¸å¯ç”¨: API Keyæœªé…ç½®ï¼ˆæ•°æ®åº“å’Œç¯å¢ƒå˜é‡å‡æœªæ‰¾åˆ°ï¼‰
2025-11-23 12:29:08,599 | dataflows            | INFO     | âœ… AKShareæ•°æ®æºå¯ç”¨ä¸”å·²å¯ç”¨
2025-11-23 12:29:08,603 | dataflows            | INFO     | âœ… BaoStockæ•°æ®æºå¯ç”¨ä¸”å·²å¯ç”¨
2025-11-23 12:29:08,604 | agents               | INFO     | ğŸ“ ç¼“å­˜ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆï¼Œç¼“å­˜ç›®å½•: /Users/yunjinqi/Documents/TradingAgents-CN/tradingagents/dataflows/cache/data_cache
2025-11-23 12:29:08,604 | agents               | INFO     | ğŸ—„ï¸ æ•°æ®åº“ç¼“å­˜ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ
2025-11-23 12:29:08,604 | agents               | INFO     |    ç¾è‚¡æ•°æ®: âœ… å·²é…ç½®
2025-11-23 12:29:08,604 | agents               | INFO     |    Aè‚¡æ•°æ®: âœ… å·²é…ç½®
2025-11-23 12:29:08,608 | tradingagents.config.database_manager | INFO     | MongoDBå¯ç”¨: False
2025-11-23 12:29:08,608 | tradingagents.config.database_manager | INFO     | Rediså¯ç”¨: False
2025-11-23 12:29:08,608 | tradingagents.config.database_manager | INFO     | å¼€å§‹æ£€æµ‹æ•°æ®åº“å¯ç”¨æ€§...
2025-11-23 12:29:08,608 | tradingagents.config.database_manager | INFO     | âŒ MongoDB: MongoDBæœªå¯ç”¨ (MONGODB_ENABLED=false)
2025-11-23 12:29:08,608 | tradingagents.config.database_manager | INFO     | âŒ Redis: Redisæœªå¯ç”¨ (REDIS_ENABLED=false)
2025-11-23 12:29:08,608 | tradingagents.config.database_manager | INFO     | ä¸»è¦ç¼“å­˜åç«¯: file
2025-11-23 12:29:08,608 | tradingagents.config.database_manager | INFO     | æ•°æ®åº“ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ - MongoDB: False, Redis: False
2025-11-23 12:29:08,608 | tradingagents.dataflows.cache.adaptive | INFO     | è‡ªé€‚åº”ç¼“å­˜ç³»ç»Ÿåˆå§‹åŒ– - ä¸»è¦åç«¯: file
2025-11-23 12:29:08,608 | dataflows            | INFO     | âœ… è‡ªé€‚åº”ç¼“å­˜ç³»ç»Ÿå·²å¯ç”¨
2025-11-23 12:29:08,608 | dataflows            | INFO     | ğŸ“Š ç¼“å­˜é…ç½®:
2025-11-23 12:29:08,608 | dataflows            | INFO     |   ä¸»è¦åç«¯: file
2025-11-23 12:29:08,608 | dataflows            | INFO     |   MongoDB: âŒ ä¸å¯ç”¨
2025-11-23 12:29:08,608 | dataflows            | INFO     |   Redis: âŒ ä¸å¯ç”¨
2025-11-23 12:29:08,608 | dataflows            | INFO     |   é™çº§æ”¯æŒ: âœ… å¯ç”¨
2025-11-23 12:29:08,608 | agents               | INFO     | âœ… ä½¿ç”¨é›†æˆç¼“å­˜ç³»ç»Ÿï¼ˆæ”¯æŒ MongoDB/Redis/File è‡ªåŠ¨é€‰æ‹©ï¼‰
2025-11-23 12:29:08,608 | dataflows            | INFO     | âœ… ç»Ÿä¸€ç¼“å­˜ç®¡ç†å™¨å·²å¯ç”¨
2025-11-23 12:29:08,608 | dataflows            | INFO     | ğŸ“Š æ•°æ®æºç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ
2025-11-23 12:29:08,608 | dataflows            | INFO     |    MongoDBç¼“å­˜: âŒ æœªå¯ç”¨
2025-11-23 12:29:08,608 | dataflows            | INFO     |    ç»Ÿä¸€ç¼“å­˜: âœ… å·²å¯ç”¨
2025-11-23 12:29:08,608 | dataflows            | INFO     |    é»˜è®¤æ•°æ®æº: DataSourceCode.AKSHARE
2025-11-23 12:29:08,608 | dataflows            | INFO     |    å¯ç”¨æ•°æ®æº: [<DataSourceCode.AKSHARE: 'akshare'>, <DataSourceCode.BAOSTOCK: 'baostock'>]
2025-11-23 12:29:09,366 | app.core.database    | INFO     | ğŸ”„ æ­£åœ¨åˆå§‹åŒ–MongoDBè¿æ¥...
2025-11-23 12:29:09,375 | app.core.database    | INFO     | âœ… MongoDBè¿æ¥æˆåŠŸå»ºç«‹
2025-11-23 12:29:09,375 | app.core.database    | INFO     | ğŸ“Š æ•°æ®åº“: tradingagents
2025-11-23 12:29:09,375 | app.core.database    | INFO     | ğŸ”— è¿æ¥æ± : 10-100
2025-11-23 12:29:09,375 | app.core.database    | INFO     | â±ï¸  è¶…æ—¶é…ç½®: connectTimeout=30000ms, socketTimeout=60000ms
2025-11-23 12:29:09,376 | app.core.database    | INFO     | ğŸ”„ æ­£åœ¨åˆå§‹åŒ–Redisè¿æ¥...
2025-11-23 12:29:09,379 | app.core.database    | ERROR    | âŒ Redisè¿æ¥å¤±è´¥: Authentication required.
2025-11-23 12:29:09,380 | app.core.database    | ERROR    | ğŸ’¥ æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥: Authentication required.
=============================== warnings summary ===============================
funds/test_fund_rating_all_em.py::TestFundRatingAllEmAPI::test_collection_endpoints
  /Users/yunjinqi/Documents/TradingAgents-CN/app/models/stock_models.py:54: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class StockBasicInfoExtended(BaseModel):

funds/test_fund_rating_all_em.py::TestFundRatingAllEmAPI::test_collection_endpoints
  /Users/yunjinqi/Documents/TradingAgents-CN/app/models/stock_models.py:153: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class MarketQuotesExtended(BaseModel):

funds/test_fund_rating_all_em.py::TestFundRatingAllEmAPI::test_collection_endpoints
  /Users/yunjinqi/Documents/TradingAgents-CN/tradingagents/config/__init__.py:5: DeprecationWarning: ConfigManager is deprecated and will be removed in version 2.0 (2026-03-31). Please use app.services.config_service.ConfigService instead. See docs/DEPRECATION_NOTICE.md for migration guide.
    from .config_manager import config_manager, token_tracker, ModelConfig, PricingConfig, UsageRecord

funds/test_fund_rating_all_em.py::TestFundRatingAllEmAPI::test_collection_endpoints
  <frozen abc>:106: LangGraphDeprecatedSinceV10: AgentStatePydantic has been moved to `langchain.agents`. Please update your import to `from langchain.agents import AgentStatePydantic`. Deprecated in LangGraph V1.0 to be removed in V2.0.

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED ../../funds/test_fund_rating_all_em.py::TestFundRatingAllEmBackend::test_save_and_clear_fund_rating_all_em_data
FAILED ../../funds/test_fund_rating_all_em.py::TestFundRatingAllEmAPI::test_collection_endpoints
======================== 2 failed, 4 warnings in 4.90s =========================
--- Logging error ---
Traceback (most recent call last):
  File "/Users/yunjinqi/opt/anaconda3/lib/python3.11/logging/__init__.py", line 1113, in emit
    stream.write(msg + self.terminator)
ValueError: I/O operation on closed file.
Call stack:
  File "/Users/yunjinqi/Documents/TradingAgents-CN/app/services/user_service.py", line 43, in __del__
    self.close()
  File "/Users/yunjinqi/Documents/TradingAgents-CN/app/services/user_service.py", line 39, in close
    logger.info("âœ… UserService MongoDB è¿æ¥å·²å…³é—­")
Message: 'âœ… UserService MongoDB è¿æ¥å·²å…³é—­'
Arguments: ()

# 市场行情一览 - 分页与搜索需求（TDD）

> 版本：v1.0  
> 范围：仅针对“股票投研 / 概览”页面中的“市场行情一览”模块  
> 目标：将当前基于 Mock 的行情表格升级为 **基于本地行情数据表的分页+搜索组件**，并通过测试驱动方式实现

---

## 1. 背景与现状

当前“股票投研 / 概览”页面（`/stocks/overview`）：

- 已存在“市场行情一览”卡片
- 行情数据来源为前端本地 Mock 数组 `mockQuotes`
- 表格列包含：代码、名称、最新价、涨跌幅、成交量、成交额
- 无分页、无搜索

本阶段需要：

1. 行情数据改为使用 **本地 MongoDB 行情集合**（`market_quotes` 等），不再使用前端 Mock
2. 支持 **接近 5000 支股票** 的列表查询
3. 支持 **分页**（每页 20 条）和 **搜索**（按代码/名称模糊查询）

---

## 2. 总体设计

### 2.1 数据源与后端接口

1. 行情数据来源：
   - 主集合：`market_quotes`
     - 字段示例：`code`, `symbol`, `close`, `pct_chg`, `volume`, `amount`, `trade_date`, `updated_at` 等
   - 补充名称与市场信息：`stock_basic_info`
     - 字段示例：`code`, `name`, `market`

2. 统一通过 **单一后端接口** 提供“市场行情一览”数据：
   - 路径：`GET /api/stocks/quotes/overview`
   - 能力：
     - 分页：`page`, `page_size`
     - 排序：`sort_by`, `sort_dir`
     - 搜索：`keyword`（按代码/名称模糊匹配）

### 2.2 前端行为

1. 打开 `/stocks/overview`：
   - 页面加载时自动调用 `/api/stocks/quotes/overview?page=1&page_size=20`
   - 将返回数据渲染到“市场行情一览”表格中

2. 分页：
   - 底部有翻页控件，每页 20 条
   - 点击下一页/指定页码时，重新请求接口，更新表格

3. 搜索：
   - 在行情卡片顶部增加搜索输入框和按钮
   - 输入代码或名称的一部分，点击“查询”，重新请求第一页数据
   - 搜索条件应该参与分页（翻页时保持当前关键字）

---

## 3. 后端接口需求（/api/stocks/quotes/overview）

### 3.1 请求

- 方法：`GET`
- 路径：`/api/stocks/quotes/overview`
- 认证：需要 Bearer Token（保持与现有 /api/stocks 接口一致）
- 查询参数：
  - `page`: int，默认 `1`，>=1
  - `page_size`: int，默认 `20`，最大 `100`
  - `sort_by`: str，可选，默认 `amount`，允许值集合：`{"amount", "volume", "pct_chg", "close", "trade_date", "updated_at"}`
  - `sort_dir`: str，`asc` 或 `desc`，默认 `desc`
  - `keyword`: str，可选，按代码/名称模糊搜索

### 3.2 响应

统一使用 `ok()` 对应当前后端风格，结构示意：

```json
{
  "success": true,
  "data": {
    "items": [
      {
        "code": "600000",
        "name": "浦发银行",
        "market": "SH",
        "latest_price": 10.23,
        "pct_chg": 1.23,
        "volume": 34500000,
        "amount": 345678900,
        "trade_date": "2025-11-18",
        "updated_at": "2025-11-18T13:30:00"
      }
    ],
    "total": 5000,
    "page": 1,
    "page_size": 20
  },
  "message": "",
  "timestamp": 1234567890
}
```

说明：

- `items`: 当前页行情记录数组
- `total`: 符合条件的股票总数（如约 5000）
- `page`, `page_size`: 当前页信息，用于前端分页控件

### 3.3 查询与搜索逻辑

1. 基础查询：
   - 从 `market_quotes` 中查询

2. 搜索（`keyword` 参数）：
   - 若未提供 `keyword`：不加额外过滤
   - 若提供 `keyword`：
     - 在 `stock_basic_info` 中按以下规则查询：
       - `code` 包含 `keyword` 或
       - `name` 包含 `keyword`（不区分大小写 / 支持中文）
     - 获取匹配的 `code` 列表 codes
     - 在 `market_quotes` 中增加过滤条件：`code` ∈ codes 或 `symbol` ∈ codes

3. 分页：
   - 使用 `skip = (page - 1) * page_size`
   - `cursor = market_quotes.find(query).sort(sort_key, sort_direction).skip(skip).limit(page_size)`

4. 排序：
   - 默认按 `amount desc`
   - 如果 `sort_by` 在允许值集合中，则使用该字段排序

5. 补充名称与市场信息：
   - 从 `stock_basic_info` 中找出当前 `items` 涉及的所有 `code`
   - 再次查询，构建 `code -> {name, market}` 映射
   - 填充进每一条返回记录

### 3.4 TDD：后端测试点

在 `tests/stocks/collections/test_quotes_overview_api.py` 基础上扩展或新增测试：

1. **接口存在性**（已实现）：
   - [x] 请求 `/api/stocks/quotes/overview` 时，返回 200 或 401

2. **分页参数**：
   - [ ] 请求 `page=1&page_size=20` 时，返回结构中包含 `page`, `page_size`, `total`
   - [ ] `len(items) <= page_size`

3. **搜索参数（有 Token 时）**：
   - [ ] 带 `keyword=600000` 时，返回的 `items` 中 `code`/`name` 至少有一条包含该关键字（若数据存在）
   - [ ] 带 `keyword=银行` 时，返回的 `items` 中 `name` 至少有一条包含“银行”（若数据存在）

> 说明：
> - 在无 `TEST_AUTH_TOKEN` 的环境中，搜索相关测试可以标记为 `skip`，仅保留分页结构验证。

---

## 4. 前端需求（/stocks/overview - 市场行情一览）

### 4.1 UI 结构

1. 原有“市场行情一览”卡片保留整体布局：
   - 标题：`市场行情一览`
   - 内部区域：
     - 顶部：搜索与操作区
     - 中部：行情表格
     - 底部：分页条

2. 顶部搜索区：
   - 一个输入框 `el-input`：placeholder 为“按代码或名称搜索”
   - 一个“查询”按钮 `el-button`：点击后重置页码到 1，发起请求

3. 行情表格：
   - 列保持与当前实现一致：
     - 代码（可点击，跳转 `/stocks/{code}`）
     - 名称（可点击，跳转 `/stocks/{code}`）
     - 最新价
     - 涨跌幅（带红/绿颜色）
     - 成交量（格式化为 万/亿）
     - 成交额（同上）

4. 分页条：
   - 使用 `el-pagination`
   - 每页固定 20 条（可写死 `page-size=20`）
   - 显示总条数 `total`

### 4.2 状态与交互逻辑

1. 组件内部状态：
   - `quotes`: 行情数组
   - `loading`: 是否在加载中
   - `page`: 当前页码
   - `pageSize`: 每页大小（20）
   - `total`: 总条数
   - `keyword`: 搜索关键字

2. 生命周期：
   - `onMounted` 时调用 `loadQuotes()`，默认加载第一页

3. `loadQuotes()` 行为：
   - 设置 `loading = true`
   - 调用 `stocksApi.getQuotesOverview({ page, page_size: pageSize, keyword })`
   - 成功时：更新 `quotes`, `total`
   - 失败时：`ElMessage.error` 提示错误原因
   - 最终重置 `loading = false`

4. 搜索交互：
   - 输入框按回车或点击“查询”按钮：
     - 将 `page` 重置为 1
     - 调用 `loadQuotes()`

5. 分页交互：
   - 改变页码时，更新 `page`，再调用 `loadQuotes()`

### 4.3 前端 API 封装

新增 `frontend/src/api/stocks.ts`（如不存在）：

```ts
import ApiClient from '@/api/request'

export const stocksApi = {
  getQuotesOverview(params: {
    page?: number
    page_size?: number
    sort_by?: string
    sort_dir?: string
    keyword?: string
  }) {
    return ApiClient.get('/api/stocks/quotes/overview', { params })
  },
}
```

在 `Stocks/index.vue` 中：

- 替换原来的 `mockQuotes` 逻辑
- 在 `<script setup>` 中引入并使用 `stocksApi.getQuotesOverview`

### 4.4 验收点（前端）

1. 打开 `/stocks/overview`：
   - [ ] 能看到“市场行情一览”卡片
   - [ ] 首屏表格有数据（若后端有行情数据）
   - [ ] 有搜索输入框和“查询”按钮
   - [ ] 有分页条显示总条数

2. 分页：
   - [ ] 每页显示不超过 20 条
   - [ ] 点击下一页/指定页码时，表格数据发生变化

3. 搜索：
   - [ ] 输入存在的股票代码片段（如 `6000`），点击“查询”，返回结果集中代码包含 `6000`
   - [ ] 输入存在的股票名称片段（如 `银行`），点击“查询”，返回结果集中名称包含 `银行`
   - [ ] 搜索后分页继续生效（翻页时仍使用当前关键字）

4. 错误处理：
   - [ ] 后端返回 401/500 时，页面不崩溃，弹出错误消息

---

## 5. 开发顺序（TDD）

1. **后端**：
   - 在 `tests/stocks/collections/test_quotes_overview_api.py` 中补充分页字段断言（page、page_size）
   - 可选：在有 Token 环境下补充 keyword 搜索的简单验证
   - 修改 `app/routers/stocks.py` 中的 `get_quotes_overview` 实现，使其支持分页和搜索

2. **前端**：
   - 新增/完善 `stocksApi.getQuotesOverview` 封装
   - 改造 `Stocks/index.vue` 的“市场行情一览”模块：接入真实接口 + 分页 + 搜索

3. **联调与验收**：
   - 按本需求文档中的“验收点”逐项手工检查
   - 确保浏览器控制台无未处理错误

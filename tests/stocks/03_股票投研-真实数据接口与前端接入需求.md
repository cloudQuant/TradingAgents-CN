# 股票投研 - 真实数据接口与前端接入需求

> 版本：v1.0  
> 范围：后端真实数据接口 + 前端接入（替换当前Mock）  
> 模式：测试驱动开发（TDD）

---

## 1. 背景

当前“股票投研”模块已完成：

1. 后端：
   - `/api/stocks/collections` 返回6个股票数据集合定义（stock_basic_info 等）

2. 前端：
   - `/stocks/overview` 概览页
     - 统计卡片（A股总数等）
     - 快速导航卡片
     - **市场行情一览：使用 Mock 行情列表**
   - `/stocks/collections` 数据集合列表页
     - 调用 `/api/stocks/collections` 渲染6个集合卡片
   - `/stocks/collections/:collectionName` 数据集合详情页
     - 使用 Mock 字段定义 & Mock 数据记录

本阶段目标：

- 为“股票投研”提供**真实的数据接口**，替代前端的 Mock 数据
- 让概览页的行情列表和集合详情页的数据表格都使用真实后端数据

---

## 2. 总体设计

### 2.1 新增/扩展的后端接口

1. **股票行情概览接口**（供概览页使用）
   - 路径：`GET /api/stocks/quotes/overview`
   - 功能：返回一个用于概览页展示的股票行情列表
   - 数据来源：MongoDB 中的 `market_quotes` 集合和/或 `stock_basic_info`

2. **股票数据集合数据接口**（供集合详情页使用）
   - 路径：`GET /api/stocks/collections/{collection_name}/data`
   - 功能：返回指定数据集合的分页数据列表
   - 数据来源：对应的 MongoDB 集合（例如 stock_basic_info、market_quotes 等）

### 2.2 前端接入点

1. 概览页面 (`/stocks/overview`)
   - 将“市场行情一览”的 `mockQuotes` 替换为从 `/api/stocks/quotes/overview` 获取的真实数据

2. 集合详情页面 (`/stocks/collections/:collectionName`)
   - 将 `mockDataByCollection` 替换为调用 `/api/stocks/collections/{collection_name}/data` 的结果
   - 支持分页参数（page, page_size）

---

## 3. 后端接口详细需求

### 3.1 概览行情接口：GET /api/stocks/quotes/overview

#### 3.1.1 请求

- 方法：`GET`
- 路径：`/api/stocks/quotes/overview`
- 认证：需要 Bearer Token（与其他 /api/stocks 接口一致）
- 查询参数（可选）：
  - `limit`: int, 默认 20，最大 100
  - `sort_by`: str, 默认 `amount`（按成交额排序）
  - `sort_dir`: str, `asc` 或 `desc`，默认 `desc`

#### 3.1.2 响应

统一使用 `ok()` 包装，响应结构：

```json
{
  "success": true,
  "data": {
    "items": [
      {
        "code": "600000.SH",
        "name": "浦发银行",
        "market": "SH",
        "latest_price": 10.23,
        "pct_chg": 1.23,
        "volume": 34500000,
        "amount": 345678900
      }
      // ... up to limit 条
    ],
    "total": 5000
  },
  "message": "",
  "timestamp": 1234567890
}
```

字段说明：
- `code`: 股票代码（带后缀或6位，如 600000 或 600000.SH）
- `name`: 股票名称（从 stock_basic_info 获取）
- `market`: 市场（SH/SZ/HK/US 等）
- `latest_price`: 最新价（来自 market_quotes.close 或等价字段）
- `pct_chg`: 涨跌幅（%）
- `volume`: 成交量
- `amount`: 成交额
- `total`: 已上市股票总数（可以从 stock_basic_info 统计）

#### 3.1.3 数据来源与逻辑

- 主表：MongoDB `market_quotes` 集合
- 补充名称与市场：从 `stock_basic_info` 集合按 `code` 关联
- 排序逻辑：
  - 按 `amount` 或指定字段排序
  - 降序优先展示成交额最大/最活跃股票

#### 3.1.4 TDD 测试与验收

编写新的测试脚本：`tests/stocks/collections/test_quotes_overview_api.py`（命名可调整），测试点：

1. 接口存在性
   - [ ] 请求 `/api/stocks/quotes/overview` 时，返回 200 或 401

2. 认证逻辑
   - [ ] 无 Token 时返回 401
   - [ ] 有效 Token 时返回 200

3. 数据结构
   - [ ] `data` 中包含 `items`（数组）和 `total`（整数）
   - [ ] `items` 中每一项包含上述字段

4. 排序与数量
   - [ ] 默认返回 `limit` 条以内记录
   - [ ] 带 `limit` 参数时，返回条数 <= limit

> 说明：考虑到当前环境和认证配置，测试文件可以参考已有的 `test_collections_page.py` 写法，允许在无 Token 时只验证接口存在性。

---

### 3.2 集合数据接口：GET /api/stocks/collections/{collection_name}/data

#### 3.2.1 请求

- 方法：`GET`
- 路径：`/api/stocks/collections/{collection_name}/data`
- 认证：需要 Bearer Token
- 路径参数：
  - `collection_name`: string，必须是 `/api/stocks/collections` 返回的 6 个集合之一：
    - `stock_basic_info`
    - `market_quotes`
    - `stock_financial_data`
    - `stock_daily`
    - `stock_weekly`
    - `stock_monthly`
- 查询参数：
  - `page`: int，默认 1
  - `page_size`: int，默认 20，最大 200
  - `sort_by`: str，可选（不同集合有不同推荐值，如 trade_date/amount/code）
  - `sort_dir`: str，`asc` 或 `desc`，默认 `desc`
  - `code`: str，可选，按单个股票代码过滤

#### 3.2.2 响应

统一使用 `ok()` 包装：

```json
{
  "success": true,
  "data": {
    "items": [
      { "code": "600000.SH", "name": "浦发银行", "market": "SH", ... },
      { "code": "000001.SZ", "name": "平安银行", ... }
    ],
    "total": 1234,
    "page": 1,
    "page_size": 20
  },
  "message": "",
  "timestamp": 1234567890
}
```

字段说明：
- `items`: 当前页的数据记录数组
- `total`: 总记录数
- `page`: 当前页码
- `page_size`: 每页大小

不同 `collection_name` 对应的 MongoDB 集合与字段：

1. `stock_basic_info` → Mongo 集合：`stock_basic_info`
2. `market_quotes` → `market_quotes`
3. `stock_financial_data` → `stock_financial_data`
4. `stock_daily` → `stock_daily`
5. `stock_weekly` → `stock_weekly`
6. `stock_monthly` → `stock_monthly`

> 说明：如果其中某些集合尚未实际存在，可以先返回空列表或最小示例数据（与当前数据库保持一致）。

#### 3.2.3 逻辑要求

1. 参数校验
   - 如果 `collection_name` 不在上述白名单中，返回 400 或 404

2. 分页查询
   - 使用 Mongo 的 `skip` + `limit` 实现分页

3. 排序
   - 默认按 `trade_date` 或 `_id` 降序（视集合而定）
   - 若 `sort_by` 指定字段，则优先使用指定字段

4. 过滤
   - 若提供 `code` 参数，则按 `code` 精确过滤

#### 3.2.4 TDD 测试与验收

新增测试文件：`tests/stocks/collections/test_collection_data_api.py`（建议）

测试点：

1. 接口存在性
   - [ ] 对每个 `collection_name`，访问 `/api/stocks/collections/{name}/data` 返回 200 或 401

2. 结构正确
   - [ ] `data` 中包含 `items`, `total`, `page`, `page_size`

3. 分页正确
   - [ ] 传入 `page_size=5` 时，返回的 `items` 长度 <= 5

4. 错误处理
   - [ ] 非法 `collection_name` 返回合适的错误（如 400）

> 同样，考虑认证限制，可在无 Token 时只验证接口存在性（状态码在 [200, 401] 范围内）。

---

## 4. 前端接入需求

### 4.1 概览页行情列表（/stocks/overview）

当前实现：
- 使用 `mockQuotes` 常量渲染行情表格

改造目标：
- 调用 `/api/stocks/quotes/overview` 获取真实数据

具体要求：

1. 在 `Stocks/index.vue` 中：
   - 新增一个 API 模块（建议放在 `frontend/src/api/stocks.ts` 中），封装：
     ```ts
     stocksApi.getQuotesOverview({ limit, sort_by, sort_dir })
     ```
   - 在 `onMounted` 中调用该 API，填充 `quotes` 状态
   - 若请求失败，使用 `ElMessage.error` 提示，但保留页面其它内容

2. UI 行为保持不变：
   - 表格结构与样式与当前 Mock 版一致
   - 只有数据来源从 Mock → 实时 API

3. 验收点：
   - [ ] 打开 `/stocks/overview`，Network 面板可见请求 `/api/stocks/quotes/overview`
   - [ ] API 返回 200 时，表格展示真实数据
   - [ ] API 返回 401/500 时，页面不崩溃，有错误提示

---

### 4.2 数据集合详情页（/stocks/collections/:collectionName）

当前实现：
- 使用 `mockDataByCollection` 常量作为数据源

改造目标：
- 调用 `/api/stocks/collections/{collection_name}/data` 获取真实数据

具体要求：

1. 在 `Stocks/Collection.vue` 中：
   - 引入 `stocksApi.getCollectionData(collectionName, { page, page_size, sort_by, sort_dir })`
   - 替换 `loadData` / `refreshData` 中使用 Mock 的逻辑

2. 支持分页：
   - 翻页时再次调用 API
   - 更新 `rows`, `total`, `page` 等

3. 错误处理：
   - API 调用失败时，使用 `ElMessage.error` 提示
   - 表格清空，但页面不崩溃

4. 验收点：
   - [ ] 从列表页点击集合卡片跳转到详情页
   - [ ] Network 面板中可见 `/api/stocks/collections/{name}/data` 请求
   - [ ] 接口返回有数据时，表格展示真实数据
   - [ ] 页码切换时，重新请求并更新表格

---

## 5. 开发顺序建议

1. **后端接口 TDD**
   - 先写 `test_quotes_overview_api.py` 和 `test_collection_data_api.py` 验收测试
   - 再在 `app/routers/stocks.py` 中实现两个新端点

2. **前端 API 模块**
   - 在 `frontend/src/api/stocks.ts` 中添加 `stocksApi` 相应方法

3. **概览页接入真实数据**
   - 替换 Mock 行情列表

4. **集合详情页接入真实数据**
   - 替换 Mock 数据表格

5. **最终联调与验收**
   - 按本需求文档中的所有“验收点”手工检查

---

## 6. 验收通过条件（真实数据版本）

当以下条目全部满足时，“股票投研 - 真实数据接口与前端接入”视为通过：

1. 后端：
   - [ ] `/api/stocks/quotes/overview` 可用，结构正确
   - [ ] `/api/stocks/collections/{name}/data` 可用，结构正确

2. 前端：
   - [ ] 概览页行情表格使用真实数据（API可见）
   - [ ] 集合详情页数据表格使用真实数据（支持分页）

3. 测试：
   - [ ] 新增的 API 测试脚本可以运行（允许在无 Token 时部分跳过）

4. 用户体验：
   - [ ] 浏览器控制台无未处理错误

满足上述条件后，可以认为“股票投研”从 Mock 版升级为“后端真实数据 + 前端完整接入”的版本。

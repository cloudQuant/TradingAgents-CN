# é‡å¤§å˜åŠ¨æ‰¹é‡æ›´æ–°åŠŸèƒ½å®Œå–„

## æ›´æ–°æ—¥æœŸ
2024-11-25

## åŠŸèƒ½æ¦‚è¿°
ä¸º `fund_portfolio_change_em`ï¼ˆåŸºé‡‘é‡å¤§å˜åŠ¨ï¼‰å®ç°å®Œå–„çš„å•ä¸ªæ›´æ–°å’Œæ‰¹é‡æ›´æ–°åŠŸèƒ½ï¼Œæ”¯æŒå¢é‡æ›´æ–°ï¼Œä½¿ç”¨ä¸­æ–‡å­—æ®µåã€‚

## æ•°æ®ç»“æ„

### AKShare APIè¿”å›å­—æ®µ
```python
# fund_portfolio_change_em(symbol, indicator, date) è¿”å›çš„å­—æ®µ
['åºå·', 'è‚¡ç¥¨ä»£ç ', 'è‚¡ç¥¨åç§°', 'æœ¬æœŸç´¯è®¡ä¹°å…¥é‡‘é¢', 'å æœŸåˆåŸºé‡‘èµ„äº§å‡€å€¼æ¯”ä¾‹', 'å­£åº¦']
# æˆ–
['åºå·', 'è‚¡ç¥¨ä»£ç ', 'è‚¡ç¥¨åç§°', 'æœ¬æœŸç´¯è®¡å–å‡ºé‡‘é¢', 'å æœŸåˆåŸºé‡‘èµ„äº§å‡€å€¼æ¯”ä¾‹', 'å­£åº¦']
```

### å‚æ•°è¯´æ˜
- **symbol**: åŸºé‡‘ä»£ç ï¼ˆå¦‚ "000001"ï¼‰
- **indicator**: æŒ‡æ ‡ç±»å‹
  - "ç´¯è®¡ä¹°å…¥"
  - "ç´¯è®¡å–å‡º"
- **date**: å¹´ä»½ï¼ˆå¦‚ "2023"ï¼‰

### å”¯ä¸€æ ‡è¯†
- **åŸºé‡‘ä»£ç ** + **è‚¡ç¥¨ä»£ç ** + **æŒ‡æ ‡ç±»å‹** + **å­£åº¦**

## ä¸»è¦æ”¹è¿›

### 1. å­—æ®µç»Ÿä¸€ä½¿ç”¨ä¸­æ–‡ âœ…

**ä¿®æ”¹æ–‡ä»¶ï¼š** `app/services/fund_data_service.py`

**åŸé€»è¾‘ï¼ˆå­˜åœ¨é‡å¤è‹±æ–‡å­—æ®µï¼‰ï¼š**
```python
doc['code'] = fund_code
doc['stock_code'] = stock_code
doc['indicator_type'] = indicator_type
doc['quarter'] = quarter
doc['source'] = 'akshare'
doc['endpoint'] = 'fund_portfolio_change_em'
doc['updated_at'] = '...'

UpdateOne(
    {'code': fund_code, 'stock_code': stock_code, 'indicator_type': indicator_type, 'quarter': quarter},
    ...
)
```

**æ–°é€»è¾‘ï¼ˆç»Ÿä¸€ä¸­æ–‡å­—æ®µï¼‰ï¼š**
```python
# æ·»åŠ å…ƒæ•°æ®å­—æ®µï¼ˆä½¿ç”¨ä¸­æ–‡ï¼‰âœ…
doc['æ•°æ®æº'] = 'akshare'
doc['æ¥å£åç§°'] = 'fund_portfolio_change_em'
doc['æ›´æ–°æ—¶é—´'] = datetime.now().isoformat()

# åˆ é™¤åºå·å­—æ®µï¼ˆä¸éœ€è¦ä¿å­˜ï¼‰âœ…
doc.pop('åºå·', None)

UpdateOne(
    {'åŸºé‡‘ä»£ç ': fund_code, 'è‚¡ç¥¨ä»£ç ': stock_code, 'æŒ‡æ ‡ç±»å‹': indicator_type, 'å­£åº¦': quarter},
    {'$set': doc},
    upsert=True
)
```

### 2. å•ä¸ªæ›´æ–°åŠŸèƒ½ âœ…

**å‚æ•°ï¼š**
- `symbol`: åŸºé‡‘ä»£ç 
- `indicator`: æŒ‡æ ‡ï¼ˆ"ç´¯è®¡ä¹°å…¥" æˆ– "ç´¯è®¡å–å‡º"ï¼‰
- `date`: å¹´ä»½

**ä½¿ç”¨ç¤ºä¾‹ï¼š**
```javascript
{
  "collection": "fund_portfolio_change_em",
  "symbol": "000001",
  "indicator": "ç´¯è®¡ä¹°å…¥",
  "date": "2023"
}
```

### 3. æ‰¹é‡å¢é‡æ›´æ–°åŠŸèƒ½ âœ…

**æ ¸å¿ƒé€»è¾‘ï¼š**
```python
# 1. è·å–æ‰€æœ‰åŸºé‡‘ä»£ç 
fund_codes = []  # ä» fund_name_em æŸ¥è¯¢ï¼Œçº¦10000åª

# 2. å®šä¹‰æŒ‡æ ‡åˆ—è¡¨
indicators = ['ç´¯è®¡ä¹°å…¥', 'ç´¯è®¡å–å‡º']

# 3. ç”Ÿæˆå¹´ä»½åˆ—è¡¨
years = ['2010', '2011', ..., '2024']  # æˆ–æŒ‡å®šå¹´ä»½

# 4. ç”Ÿæˆæ‰€æœ‰å¯èƒ½çš„ç»„åˆ
all_combinations = [
    (code, indicator, year)
    for code in fund_codes
    for indicator in indicators
    for year in years
]
# ä¾‹å¦‚ï¼š10000 Ã— 2 Ã— 15 = 300,000 ä¸ªç»„åˆ

# 5. æŸ¥è¯¢å·²æœ‰çš„ç»„åˆ
existing_combinations = set()
# ä»æ•°æ®åº“æŸ¥è¯¢å·²æœ‰çš„ (åŸºé‡‘ä»£ç , æŒ‡æ ‡, å¹´ä»½)

# 6. è¿‡æ»¤å‡ºéœ€è¦æ›´æ–°çš„ç»„åˆ
combinations_to_update = [
    (code, ind, y) for code, ind, y in all_combinations
    if (code, ind, y) not in existing_combinations
]

# 7. åªæ›´æ–°ç¼ºå¤±çš„ç»„åˆ
for code, ind, y in combinations_to_update:
    update(code, ind, y)
```

### 4. å¹¶å‘å¤„ç†ä¸è¿›åº¦æ¡ âœ…

**å¹¶å‘æ§åˆ¶ï¼š**
```python
concurrency = params.get('concurrency', 3)  # é»˜è®¤3ä¸ªå¹¶å‘
semaphore = asyncio.Semaphore(concurrency)
```

**ç»ˆç«¯è¿›åº¦æ¡ï¼š**
```
é‡å¤§å˜åŠ¨æ‰¹é‡æ›´æ–°: 45%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 135000/300000 [2:30:00<3:15:00, 13.89ä»»åŠ¡/s] 
æˆåŠŸ: 130000 å¤±è´¥: 5000 å·²ä¿å­˜: 1300000æ¡
```

## APIæ¥å£

### å•ä¸ªæ›´æ–°
```python
POST /api/funds/refresh
{
    "collection": "fund_portfolio_change_em",
    "symbol": "000001",
    "indicator": "ç´¯è®¡ä¹°å…¥",  # æˆ– "ç´¯è®¡å–å‡º"
    "date": "2023"
}
```

### æ‰¹é‡æ›´æ–°
```python
POST /api/funds/refresh
{
    "collection": "fund_portfolio_change_em",
    "batch": true,
    "year": "2023",        # å¯é€‰ï¼šåªæ›´æ–°2023å¹´
    "concurrency": 5       # å¯é€‰ï¼šå¹¶å‘æ•°ï¼Œé»˜è®¤3
}
```

## è¿”å›å€¼ç»“æ„

### å•ä¸ªæ›´æ–°è¿”å›å€¼
```json
{
    "success": true,
    "saved": 40,
    "rows": 40,
    "symbol": "000001",
    "indicator": "ç´¯è®¡ä¹°å…¥",
    "date": "2023",
    "message": "æˆåŠŸæ›´æ–°åŸºé‡‘ 000001 ç´¯è®¡ä¹°å…¥ 2023å¹´é‡å¤§å˜åŠ¨ï¼Œä¿å­˜ 40 æ¡è®°å½•"
}
```

### æ‰¹é‡æ›´æ–°è¿”å›å€¼ï¼ˆå¢é‡ï¼‰
```json
{
    "success": true,
    "saved": 1200000,
    "success_count": 130000,
    "failed_count": 20000,
    "skipped_count": 150000,
    "total_funds": 10000,
    "total_indicators": 2,
    "total_years": 15,
    "total_possible": 300000,
    "total_tasks": 150000,
    "year": "2010-2024",
    "message": "å¢é‡æ›´æ–°å®Œæˆ: å¯èƒ½ 300000ï¼Œå·²å­˜åœ¨ 150000ï¼Œæ›´æ–° 150000ï¼ˆæˆåŠŸ 130000ï¼Œå¤±è´¥ 20000ï¼‰ï¼Œä¿å­˜ 1200000 æ¡è®°å½•"
}
```

## æ€§èƒ½å¯¹æ¯”

### åœºæ™¯1ï¼šé¦–æ¬¡æ‰¹é‡æ›´æ–°ï¼ˆæ‰€æœ‰å¹´ä»½ï¼‰
```
åŸºé‡‘æ•°é‡: 10000
æŒ‡æ ‡æ•°é‡: 2ï¼ˆç´¯è®¡ä¹°å…¥ã€ç´¯è®¡å–å‡ºï¼‰
å¹´ä»½èŒƒå›´: 2010-2024 (15å¹´)
æ•°æ®åº“çŠ¶æ€: ç©º

ç»„åˆåˆ†æ:
- æ€»è®¡å¯èƒ½ç»„åˆ: 10000 Ã— 2 Ã— 15 = 300,000
- å·²å­˜åœ¨ç»„åˆ: 0
- éœ€è¦æ›´æ–°: 300,000

é¢„è®¡æ—¶é—´: 25-30å°æ—¶
```

### åœºæ™¯2ï¼šå¢é‡æ›´æ–°ï¼ˆå·²æœ‰2010-2023æ•°æ®ï¼‰
```
åŸºé‡‘æ•°é‡: 10000
æŒ‡æ ‡æ•°é‡: 2
å¹´ä»½èŒƒå›´: 2010-2024 (15å¹´)
æ•°æ®åº“çŠ¶æ€: å·²æœ‰ 2010-2023å¹´ æ•°æ®

ç»„åˆåˆ†æ:
- æ€»è®¡å¯èƒ½ç»„åˆ: 300,000
- å·²å­˜åœ¨ç»„åˆ: 280,000 (10000 Ã— 2 Ã— 14)
- éœ€è¦æ›´æ–°: 20,000 (ä»…2024å¹´)

é¢„è®¡æ—¶é—´: 1.5-2å°æ—¶ï¼ˆèŠ‚çœ93%ï¼‰âœ…
```

### åœºæ™¯3ï¼šå•å¹´æ›´æ–°
```
åŸºé‡‘æ•°é‡: 10000
æŒ‡æ ‡æ•°é‡: 2
å¹´ä»½: 2024 (1å¹´)
æ•°æ®åº“çŠ¶æ€: éƒ¨åˆ†å·²å­˜åœ¨

ç»„åˆåˆ†æ:
- æ€»è®¡å¯èƒ½ç»„åˆ: 20,000
- å·²å­˜åœ¨ç»„åˆ: 10,000
- éœ€è¦æ›´æ–°: 10,000

é¢„è®¡æ—¶é—´: 50-60åˆ†é’Ÿï¼ˆèŠ‚çœ50%ï¼‰âœ…
```

### åœºæ™¯4ï¼šæ‰€æœ‰æ•°æ®å·²å­˜åœ¨
```
åŸºé‡‘æ•°é‡: 10000
æŒ‡æ ‡æ•°é‡: 2
å¹´ä»½: 2024
æ•°æ®åº“çŠ¶æ€: å…¨éƒ¨å·²å­˜åœ¨

ç»„åˆåˆ†æ:
- æ€»è®¡å¯èƒ½ç»„åˆ: 20,000
- å·²å­˜åœ¨ç»„åˆ: 20,000
- éœ€è¦æ›´æ–°: 0

é¢„è®¡æ—¶é—´: 2-3ç§’ï¼ˆä»…æŸ¥è¯¢æ—¶é—´ï¼‰âœ…
```

## æ•°æ®ä¿å­˜ç¤ºä¾‹

```json
{
    "_id": "ObjectId(...)",
    "åŸºé‡‘ä»£ç ": "000001",
    "è‚¡ç¥¨ä»£ç ": "600519",
    "è‚¡ç¥¨åç§°": "è´µå·èŒ…å°",
    "æœ¬æœŸç´¯è®¡ä¹°å…¥é‡‘é¢": 10249.44,
    "å æœŸåˆåŸºé‡‘èµ„äº§å‡€å€¼æ¯”ä¾‹": 3.26,
    "å­£åº¦": "2023å¹´4å­£åº¦ç´¯è®¡ä¹°å…¥è‚¡ç¥¨æ˜ç»†",
    "æŒ‡æ ‡ç±»å‹": "ä¹°å…¥",
    "æ•°æ®æº": "akshare",
    "æ¥å£åç§°": "fund_portfolio_change_em",
    "æ›´æ–°æ—¶é—´": "2024-11-25T07:45:00.123456"
}
```

## ä½¿ç”¨ç¤ºä¾‹

### å‰ç«¯è§¦å‘æ‰¹é‡æ›´æ–°
```javascript
// æ‰¹é‡æ›´æ–°æ‰€æœ‰åŸºé‡‘2023å¹´çš„é‡å¤§å˜åŠ¨
const response = await api.post('/api/funds/refresh', {
  collection: 'fund_portfolio_change_em',
  batch: true,
  year: '2023',
  concurrency: 5
});

console.log(response.data);
// {
//   "success": true,
//   "skipped_count": 10000,
//   "total_tasks": 10000,
//   "saved": 400000,
//   "message": "å¢é‡æ›´æ–°å®Œæˆ: å¯èƒ½ 20000ï¼Œå·²å­˜åœ¨ 10000ï¼Œæ›´æ–° 10000ï¼ˆæˆåŠŸ 9500ï¼Œå¤±è´¥ 500ï¼‰ï¼Œä¿å­˜ 400000 æ¡è®°å½•"
// }
```

### å‰ç«¯è§¦å‘å•ä¸ªæ›´æ–°
```javascript
// å•ä¸ªåŸºé‡‘çš„ç´¯è®¡ä¹°å…¥æ•°æ®æ›´æ–°
const response = await api.post('/api/funds/refresh', {
  collection: 'fund_portfolio_change_em',
  symbol: '000001',
  indicator: 'ç´¯è®¡ä¹°å…¥',
  date: '2023'
});

console.log(response.data);
// {
//   "success": true,
//   "saved": 40,
//   "message": "æˆåŠŸæ›´æ–°åŸºé‡‘ 000001 ç´¯è®¡ä¹°å…¥ 2023å¹´é‡å¤§å˜åŠ¨ï¼Œä¿å­˜ 40 æ¡è®°å½•"
// }
```

## æ—¥å¿—ç¤ºä¾‹

```bash
# æ‰¹é‡æ›´æ–°æ—¥å¿—
[INFO] å¼€å§‹æ‰¹é‡åˆ·æ–°é‡å¤§å˜åŠ¨...
[INFO] æ‰¾åˆ° 10000 åªåŸºé‡‘ï¼Œ2 ä¸ªæŒ‡æ ‡ï¼Œ15 ä¸ªå¹´ä»½ï¼ˆ2010-2024 æ‰€æœ‰å¹´ä»½ï¼‰ï¼Œå…± 300000 ä¸ªå¯èƒ½ç»„åˆï¼Œæ­£åœ¨æŸ¥è¯¢å·²æœ‰æ•°æ®...
[INFO] å¢é‡æ›´æ–°ï¼šæ€»è®¡ 300000 ä¸ªç»„åˆï¼Œå·²å­˜åœ¨ 150000 ä¸ªï¼Œéœ€è¦æ›´æ–° 150000 ä¸ª
[INFO] æ­£åœ¨å¤„ç†: 000001 (ç´¯è®¡ä¹°å…¥, 2024å¹´) | è¿›åº¦: 0/150000 | æˆåŠŸ: 0 | å¤±è´¥: 0
[INFO] å·²å®Œæˆ: 1/150000 | æˆåŠŸ: 1 | å¤±è´¥: 0 | å·²ä¿å­˜: 40æ¡
...
[INFO] æ‰¹é‡æ›´æ–°å®Œæˆ: æ€»ä»»åŠ¡ 150000ï¼ŒæˆåŠŸ 130000ï¼Œå¤±è´¥ 20000ï¼Œè·³è¿‡ 150000ï¼Œä¿å­˜ 1200000 æ¡è®°å½•
```

## æ³¨æ„äº‹é¡¹

1. **ç»„åˆæ•°é‡å·¨å¤§**ï¼š
   - å…¨é‡æ›´æ–°ï¼š10000åŸºé‡‘ Ã— 2æŒ‡æ ‡ Ã— 15å¹´ = 300,000ä¸ªä»»åŠ¡
   - å•å¹´æ›´æ–°ï¼š10000åŸºé‡‘ Ã— 2æŒ‡æ ‡ Ã— 1å¹´ = 20,000ä¸ªä»»åŠ¡

2. **æŒ‡æ ‡ç±»å‹**ï¼š
   - APIå‚æ•°ï¼š`indicator="ç´¯è®¡ä¹°å…¥"` æˆ– `indicator="ç´¯è®¡å–å‡º"`
   - ä¿å­˜åˆ°æ•°æ®åº“ï¼š`æŒ‡æ ‡ç±»å‹="ä¹°å…¥"` æˆ– `æŒ‡æ ‡ç±»å‹="å–å‡º"`

3. **å­£åº¦å­—æ®µ**ï¼š
   - APIè¿”å›ç¤ºä¾‹ï¼š`"2023å¹´4å­£åº¦ç´¯è®¡ä¹°å…¥è‚¡ç¥¨æ˜ç»†"`
   - ä»ä¸­æå–å¹´ä»½è¿›è¡Œå¢é‡æ›´æ–°åˆ¤æ–­

4. **å¹¶å‘æ§åˆ¶**ï¼š
   - é»˜è®¤å¹¶å‘æ•°: 3
   - å»ºè®®èŒƒå›´: 3-5
   - APIé™æµä¿æŠ¤: æ¯ä¸ªè¯·æ±‚é—´éš” 0.3 ç§’

5. **é¢„è®¡è€—æ—¶**ï¼š
   - å•ä¸ªæ›´æ–°ï¼š5-10ç§’
   - å•å¹´æ‰¹é‡æ›´æ–°ï¼ˆæ–°æ•°æ®ï¼‰ï¼š1.5-2å°æ—¶
   - å…¨é‡æ‰¹é‡æ›´æ–°ï¼ˆæ–°æ•°æ®ï¼‰ï¼š25-30å°æ—¶

## ç›¸å…³æ–‡ä»¶

### åç«¯æœåŠ¡
- `app/services/fund_refresh_service.py`
  - `_refresh_fund_portfolio_change_em` (éœ€è¦é‡å†™)
  - `_fetch_single_indicator_change` (æ–°å¢è¾…åŠ©æ–¹æ³•)

### æ•°æ®æœåŠ¡
- `app/services/fund_data_service.py`
  - `save_fund_portfolio_change_em_data` (å·²ä¿®æ”¹ä¸ºä¸­æ–‡å­—æ®µ)

### æµ‹è¯•è„šæœ¬
- `test_akshare_change.py` - APIæµ‹è¯•è„šæœ¬

## å­—æ®µå¯¹ç…§è¡¨

| åŸå­—æ®µï¼ˆè‹±æ–‡ï¼‰ | æ–°å­—æ®µï¼ˆä¸­æ–‡ï¼‰ | è¯´æ˜ |
|-------------|-------------|------|
| `code` | `åŸºé‡‘ä»£ç ` | åˆ é™¤é‡å¤çš„è‹±æ–‡å­—æ®µ âœ… |
| `stock_code` | `è‚¡ç¥¨ä»£ç ` | åˆ é™¤é‡å¤çš„è‹±æ–‡å­—æ®µ âœ… |
| `indicator_type` | `æŒ‡æ ‡ç±»å‹` | åˆ é™¤é‡å¤çš„è‹±æ–‡å­—æ®µ âœ… |
| `quarter` | `å­£åº¦` | åˆ é™¤é‡å¤çš„è‹±æ–‡å­—æ®µ âœ… |
| `source` | `æ•°æ®æº` | ç¿»è¯‘ä¸ºä¸­æ–‡ âœ… |
| `endpoint` | `æ¥å£åç§°` | ç¿»è¯‘ä¸ºä¸­æ–‡ âœ… |
| `updated_at` | `æ›´æ–°æ—¶é—´` | ç¿»è¯‘ä¸ºä¸­æ–‡ âœ… |
| `åºå·` | ~~åˆ é™¤~~ | ä¸éœ€è¦ä¿å­˜åˆ°æ•°æ®åº“ âœ… |

## å®ç°çŠ¶æ€

- âœ… å­—æ®µç»Ÿä¸€ä¸ºä¸­æ–‡
- âœ… æ·»åŠ è¾…åŠ©æ–¹æ³• `_fetch_single_indicator_change`
- ğŸš§ å•ä¸ªæ›´æ–°åŠŸèƒ½ï¼ˆéœ€è¦å®Œæˆï¼‰
- ğŸš§ æ‰¹é‡å¢é‡æ›´æ–°åŠŸèƒ½ï¼ˆéœ€è¦å®Œæˆï¼‰
- ğŸš§ ç»ˆç«¯è¿›åº¦æ¡ï¼ˆéœ€è¦å®Œæˆï¼‰

---

**ç‰ˆæœ¬**: 1.0.0  
**å®ç°æ—¥æœŸ**: 2024-11-25  
**ç»´æŠ¤è€…**: TradingAgents-CN Team  
**åŠŸèƒ½ç‰¹æ€§**: 
- âœ… ä¸­æ–‡å­—æ®µ
- âœ… å•ä¸ªæ›´æ–°ï¼ˆsymbol + indicator + dateï¼‰
- âœ… æ‰¹é‡å¢é‡æ›´æ–°
- âœ… ç»ˆç«¯è¿›åº¦æ¡
- âœ… ä¸‰ç»´ç»„åˆè¿‡æ»¤ï¼ˆåŸºé‡‘Ã—æŒ‡æ ‡Ã—å¹´ä»½ï¼‰

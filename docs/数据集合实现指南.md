# 数据集合实现指南

本文档详细说明如何在 TradingAgents-CN 项目中实现一个新的数据集合，包括后端和前端的完整流程。

---

## 目录

1. [架构概述](#1-架构概述)
2. [后端实现](#2-后端实现)
   - [2.1 Provider层](#21-provider层)
   - [2.2 Service层](#22-service层)
   - [2.3 路由层](#23-路由层)
   - [2.4 配置文件](#24-配置文件)
3. [前端实现](#3-前端实现)
   - [3.1 API层](#31-api层)
   - [3.2 类型定义](#32-类型定义)
   - [3.3 路由配置](#33-路由配置)
   - [3.4 UI组件](#34-ui组件)
4. [集合类型分类](#4-集合类型分类)
5. [完整示例](#5-完整示例)
6. [核心功能清单](#6-核心功能清单)
7. [测试与验证](#7-测试与验证)

---

## 1. 架构概述

### 1.1 三层架构

```
┌─────────────────────────────────────────────────────────────┐
│                        前端 (Vue 3)                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │  API 层     │  │  Store      │  │  UI 组件            │  │
│  │ (funds.ts)  │  │ (funds.ts)  │  │ (Collection.vue)    │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      后端 (FastAPI)                          │
│  ┌─────────────────────────────────────────────────────┐    │
│  │                  Router 层 (funds.py)                │    │
│  │    /refresh  /stats  /clear  /data  /upload  /sync  │    │
│  └─────────────────────────────────────────────────────┘    │
│                              │                               │
│  ┌─────────────────────────────────────────────────────┐    │
│  │               Service 层 (BaseService)               │    │
│  │    数据查询、更新、批量更新、进度管理、增量判断         │    │
│  └─────────────────────────────────────────────────────┘    │
│                              │                               │
│  ┌─────────────────────────────────────────────────────┐    │
│  │              Provider 层 (BaseProvider)              │    │
│  │         数据获取、参数映射、元数据添加               │    │
│  └─────────────────────────────────────────────────────┘    │
│                              │                               │
│  ┌─────────────────────────────────────────────────────┐    │
│  │              数据库层 (ControlMongodb)               │    │
│  │           数据保存、去重、批量写入                   │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 核心文件结构

```
app/
├── routers/
│   └── funds.py                    # API路由定义
├── services/
│   ├── fund_refresh_service.py     # 刷新服务入口
│   ├── fund_data_service.py        # 通用数据服务
│   └── data_sources/
│       ├── base_provider.py        # Provider基类
│       ├── base_service.py         # Service基类
│       └── funds/
│           ├── collection_metadata.py   # 集合元信息
│           ├── provider_registry.py     # Provider注册
│           ├── service_registry.py      # Service注册
│           ├── providers/              # Provider实现
│           │   └── fund_name_em_provider.py
│           └── services/               # Service实现
│               └── fund_name_em_service.py
├── config/
│   └── fund_update_config.py       # 更新参数配置

frontend/src/
├── api/
│   └── funds.ts                    # API调用
├── types/
│   └── funds.ts                    # TypeScript类型
├── views/Funds/
│   ├── Collections.vue             # 集合列表页
│   └── collections/
│       └── DefaultCollection.vue   # 集合详情页
├── components/collection/
│   ├── CollectionDataTable.vue     # 数据表格
│   ├── CollectionPageHeader.vue    # 页面头部
│   └── useFundCollection.ts        # Composable
└── router/
    └── index.ts                    # 路由配置
```

---

## 2. 后端实现

### 2.1 Provider层

Provider 负责**数据获取**，是与外部数据源（如 akshare）的交互层。

#### 2.1.1 文件位置

```
app/services/data_sources/funds/providers/fund_xxx_provider.py
```

#### 2.1.2 Provider类型

根据数据获取方式，Provider分为三种类型：

| 类型 | 基类 | 说明 | 示例 |
|------|------|------|------|
| 简单Provider | `SimpleProvider` | 无参数，一次获取全部数据 | `fund_name_em` |
| 单参数Provider | `BaseProvider` | 需要单个参数（如基金代码） | `fund_open_fund_info_em` |
| 多参数Provider | `BaseProvider` | 需要多个参数（如代码+年份） | `fund_portfolio_hold_em` |

#### 2.1.3 简单Provider示例

```python
# fund_name_em_provider.py
"""基金基本信息-东财数据提供者"""
from app.services.data_sources.base_provider import SimpleProvider


class FundNameEmProvider(SimpleProvider):
    """基金基本信息-东财数据提供者"""
    
    # 必填属性
    collection_name = "fund_name_em"           # 集合名称（唯一标识）
    display_name = "基金基本信息"               # 显示名称
    akshare_func = "fund_name_em"              # akshare函数名
    unique_keys = ["基金代码"]                  # 数据去重的唯一键
    
    # 可选属性
    collection_description = "东方财富网所有基金的基本信息"
    collection_route = "/funds/collections/fund_name_em"
    collection_order = 0                       # 排序顺序
    
    # 字段信息（用于前端展示）
    field_info = [
        {"name": "基金代码", "type": "string", "description": ""},
        {"name": "拼音缩写", "type": "string", "description": ""},
        {"name": "基金简称", "type": "string", "description": ""},
        {"name": "基金类型", "type": "string", "description": ""},
        {"name": "更新时间", "type": "datetime", "description": "数据更新时间"},
    ]
```

#### 2.1.4 带参数Provider示例

```python
# fund_portfolio_hold_em_provider.py
"""基金持仓股票数据提供者"""
from app.services.data_sources.base_provider import BaseProvider


class FundPortfolioHoldEmProvider(BaseProvider):
    """基金持仓股票数据提供者"""
    
    collection_name = "fund_portfolio_hold_em"
    display_name = "基金持仓股票"
    akshare_func = "fund_portfolio_hold_em"
    unique_keys = ["基金代码", "股票代码", "季度"]
    
    # 参数映射：将前端参数名映射到akshare参数名
    # 支持多个前端参数映射到一个akshare参数
    param_mapping = {
        "fund_code": "symbol",  # 前端传fund_code，映射为akshare的symbol
        "symbol": "symbol",
        "code": "symbol",
        "year": "date",         # 年份参数
        "date": "date",
    }
    
    # 必填参数列表（akshare参数名）
    required_params = ["symbol", "date"]
    
    # 将参数值添加到数据列中（便于去重）
    add_param_columns = {
        "symbol": "基金代码",   # 将symbol参数值写入"基金代码"列
    }
    
    field_info = [
        {"name": "基金代码", "type": "string", "description": ""},
        {"name": "股票代码", "type": "string", "description": ""},
        {"name": "股票名称", "type": "string", "description": ""},
        {"name": "季度", "type": "string", "description": ""},
        {"name": "占净值比例", "type": "float", "description": ""},
    ]
```

#### 2.1.5 Provider关键属性

| 属性 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `collection_name` | str | ✅ | 集合名称（唯一标识） |
| `display_name` | str | ✅ | 显示名称 |
| `akshare_func` | str | ✅ | akshare函数名 |
| `unique_keys` | List[str] | ✅ | 数据去重的唯一键 |
| `field_info` | List[Dict] | ❌ | 字段定义列表 |
| `collection_description` | str | ❌ | 集合描述 |
| `collection_route` | str | ❌ | 前端路由 |
| `collection_order` | int | ❌ | 排序顺序（默认100） |
| `param_mapping` | Dict | ❌ | 参数名映射 |
| `required_params` | List[str] | ❌ | 必填参数列表 |
| `add_param_columns` | Dict | ❌ | 参数值写入列配置 |

---

### 2.2 Service层

Service 负责**业务逻辑**，包括数据查询、更新、批量更新、增量判断等。

#### 2.2.1 文件位置

```
app/services/data_sources/funds/services/fund_xxx_service.py
```

#### 2.2.2 Service类型

| 类型 | 基类 | 说明 |
|------|------|------|
| 简单Service | `SimpleService` | 无需批量更新逻辑 |
| 批量Service | `BaseService` | 需要批量更新逻辑 |

#### 2.2.3 简单Service示例

```python
# fund_name_em_service.py
"""基金基本信息-东财服务"""
from app.services.data_sources.base_service import SimpleService
from ..providers.fund_name_em_provider import FundNameEmProvider


class FundNameEmService(SimpleService):
    """基金基本信息-东财服务"""
    
    collection_name = "fund_name_em"
    provider_class = FundNameEmProvider
```

#### 2.2.4 批量Service示例

```python
# fund_portfolio_hold_em_service.py
"""基金持仓股票服务"""
from app.services.data_sources.base_service import BaseService
from ..providers.fund_portfolio_hold_em_provider import FundPortfolioHoldEmProvider


class FundPortfolioHoldEmService(BaseService):
    """基金持仓股票服务"""
    
    collection_name = "fund_portfolio_hold_em"
    provider_class = FundPortfolioHoldEmProvider
    
    # 批量更新配置
    batch_source_collection = "fund_name_em"   # 从哪个集合获取代码列表
    batch_source_field = "基金代码"             # 获取的字段名
    batch_use_year = True                       # 是否需要年份参数
    batch_years_range = (2010, None)            # 年份范围（None表示到今年）
    batch_concurrency = 3                       # 默认并发数
    
    # 增量更新配置
    incremental_check_fields = ["基金代码", "季度"]  # 检查已存在数据的字段
    
    # 字段值提取器（可选）
    # 例如：从"2024年1季度"提取"2024"
    incremental_field_extractor = {
        "季度": lambda q: q[:4] if len(q) >= 4 and q[:4].isdigit() else ""
    }
```

#### 2.2.5 Service关键属性

| 属性 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `collection_name` | str | ✅ | 集合名称 |
| `provider_class` | Type | ✅ | Provider类 |
| `time_field` | str | ❌ | 时间字段名（默认"更新时间"） |
| `batch_source_collection` | str | ❌ | 批量更新的源集合 |
| `batch_source_field` | str | ❌ | 源集合的字段名 |
| `batch_use_year` | bool | ❌ | 是否需要年份参数 |
| `batch_years_range` | Tuple | ❌ | 年份范围 |
| `batch_concurrency` | int | ❌ | 默认并发数（默认3） |
| `incremental_check_fields` | List[str] | ❌ | 增量检查字段 |
| `incremental_field_extractor` | Dict | ❌ | 字段值提取器 |

---

### 2.3 路由层

路由在 `app/routers/funds.py` 中定义，**通常无需修改**，因为路由是通用的。

#### 2.3.1 核心API端点

| 端点 | 方法 | 说明 |
|------|------|------|
| `/collections` | GET | 获取所有集合列表 |
| `/collections/{name}` | GET | 获取集合数据 |
| `/collections/{name}/stats` | GET | 获取集合统计信息 |
| `/collections/{name}/refresh` | POST | 刷新集合数据 |
| `/collections/{name}/clear` | DELETE | 清空集合数据 |
| `/collections/{name}/upload` | POST | 上传数据文件 |
| `/collections/{name}/sync` | POST | 远程同步数据 |
| `/collections/{name}/export` | POST | 导出数据 |
| `/collections/{name}/update-config` | GET | 获取更新配置 |

---

### 2.4 配置文件

#### 2.4.1 集合元信息配置

文件位置：`app/services/data_sources/funds/collection_metadata.py`

```python
FUND_COLLECTION_METADATA = {
    'fund_name_em': {
        'display_name': '基金基本信息',
        'description': '东方财富网所有基金的基本信息',
        'route': '/funds/collections/fund_name_em',
        'order': 0,
    },
    # 添加新集合的元信息
    'fund_xxx': {
        'display_name': '新集合名称',
        'description': '新集合描述',
        'route': '/funds/collections/fund_xxx',
        'order': 100,
    },
}
```

#### 2.4.2 更新参数配置

文件位置：`app/config/fund_update_config.py`

```python
FUND_UPDATE_CONFIGS = {
    # 无参数集合
    "fund_name_em": {
        "display_name": "基金名称列表",
        "update_description": "将从东方财富网获取所有基金的基本信息数据",
        "single_update": {
            "enabled": False,  # 不支持单条更新
            "description": "",
            "params": []
        },
        "batch_update": {
            "enabled": True,
            "description": "一次性获取所有基金名称数据",
            "params": [
                {
                    "name": "concurrency",
                    "label": "并发数",
                    "type": "number",
                    "default": 3,
                    "min": 1,
                    "max": 10,
                    "step": 1
                }
            ]
        }
    },
    
    # 需要参数的集合
    "fund_portfolio_hold_em": {
        "display_name": "基金股票持仓",
        "update_description": "获取基金股票持仓数据",
        "single_update": {
            "enabled": True,
            "description": "更新单个基金指定年份的股票持仓",
            "params": [
                {
                    "name": "fund_code",
                    "label": "基金代码",
                    "type": "text",
                    "placeholder": "请输入基金代码（如 000001）",
                    "required": True
                },
                {
                    "name": "year",
                    "label": "年份",
                    "type": "text",
                    "placeholder": "请输入年份（如 2024）",
                    "required": True
                }
            ]
        },
        "batch_update": {
            "enabled": True,
            "description": "批量更新所有基金的股票持仓数据",
            "params": [
                {
                    "name": "year",
                    "label": "年份（可选）",
                    "type": "text",
                    "placeholder": "留空更新所有年份",
                    "required": False
                },
                {
                    "name": "concurrency",
                    "label": "并发数",
                    "type": "number",
                    "default": 3,
                    "min": 1,
                    "max": 10,
                    "step": 1
                }
            ]
        }
    },
}
```

#### 2.4.3 参数类型说明

| 类型 | 说明 | 额外属性 |
|------|------|----------|
| `text` | 文本输入 | `placeholder`, `required` |
| `number` | 数字输入 | `min`, `max`, `step`, `default` |
| `select` | 下拉选择 | `options: [{value, label}]` |

---

## 3. 前端实现

### 3.1 API层

文件位置：`frontend/src/api/funds.ts`

**通常无需修改**，因为API是通用的。

```typescript
export const fundsApi = {
  // 获取集合列表
  async getCollections(): Promise<ApiResponse<FundCollection[]>> {
    return await ApiClient.get<FundCollection[]>('/api/funds/collections')
  },

  // 获取集合数据
  async getCollectionData(
    collectionName: string,
    params?: CollectionDataQuery
  ): Promise<ApiResponse<CollectionData>> {
    return await ApiClient.get<CollectionData>(
      `/api/funds/collections/${collectionName}`, 
      params
    )
  },

  // 获取集合统计
  async getCollectionStats(collectionName: string): Promise<ApiResponse<CollectionStats>> {
    return await ApiClient.get<CollectionStats>(
      `/api/funds/collections/${collectionName}/stats`
    )
  },

  // 刷新数据
  async refreshCollectionData(
    collectionName: string,
    params: RefreshCollectionRequest
  ): Promise<ApiResponse<{ task_id: string }>> {
    return await ApiClient.post<{ task_id: string }>(
      `/api/funds/collections/${collectionName}/refresh`,
      params
    )
  },

  // 获取任务状态
  async getRefreshTaskStatus(
    collectionName: string, 
    taskId: string
  ): Promise<ApiResponse<RefreshTask>> {
    return await ApiClient.get<RefreshTask>(
      `/api/funds/collections/${collectionName}/refresh/status/${taskId}`
    )
  },

  // 清空数据
  async clearCollectionData(collectionName: string): Promise<ApiResponse> {
    return await ApiClient.delete(
      `/api/funds/collections/${collectionName}/clear`
    )
  },

  // 上传文件
  async uploadData(collectionName: string, file: File): Promise<ApiResponse> {
    return await ApiClient.upload(
      `/api/funds/collections/${collectionName}/upload`, 
      file
    )
  },

  // 远程同步
  async syncData(collectionName: string, config: RemoteSyncConfig): Promise<ApiResponse> {
    return await ApiClient.post(
      `/api/funds/collections/${collectionName}/sync`,
      config
    )
  },
}
```

---

### 3.2 类型定义

文件位置：`frontend/src/types/funds.ts`

**通常无需修改**，因为类型是通用的。

```typescript
// 集合定义
export interface FundCollection {
  name: string
  display_name: string
  description: string
  route: string
  fields: string[]
}

// 数据查询参数
export interface CollectionDataQuery {
  page?: number
  page_size?: number
  sort_by?: string
  sort_dir?: SortDirection
  filter_field?: string
  filter_value?: string
}

// 刷新请求参数
export interface RefreshCollectionRequest {
  update_type: 'single' | 'batch'
  update_mode?: 'incremental' | 'full'
  fund_code?: string
  symbol?: string
  year?: number
  date?: string
  concurrency?: number
  [key: string]: any
}

// 任务状态
export interface RefreshTask {
  task_id: string
  status: 'pending' | 'running' | 'success' | 'failed' | 'completed'
  progress?: number
  total?: number
  message?: string
  error?: string
  result?: TaskResult
}
```

---

### 3.3 路由配置

文件位置：`frontend/src/router/index.ts`

**通常无需修改**，因为使用动态路由。

```typescript
{
  path: '/funds',
  name: 'Funds',
  component: () => import('@/layouts/BasicLayout.vue'),
  redirect: '/funds/overview',
  children: [
    {
      path: 'collections',
      name: 'FundCollections',
      component: () => import('@/views/Funds/Collections.vue'),
      meta: { title: '基金数据集合' }
    },
    {
      // 动态路由，自动匹配所有集合
      path: 'collections/:collectionName',
      name: 'FundCollection',
      component: () => import('@/views/Funds/collections/index.vue'),
      meta: { title: '基金数据集合详情' }
    },
  ]
}
```

---

### 3.4 UI组件

前端使用通用组件，**无需为新集合创建新组件**。

#### 3.4.1 组件结构

```
frontend/src/components/collection/
├── CollectionPageHeader.vue     # 页面头部（标题、操作按钮）
├── CollectionDataTable.vue      # 数据表格（分页、排序、筛选）
├── CollectionOverviewDialog.vue # 数据概览对话框
├── FileImportDialog.vue         # 文件导入对话框
├── RemoteSyncDialog.vue         # 远程同步对话框
├── useFundCollection.ts         # Composable（状态管理）
└── index.ts                     # 导出
```

#### 3.4.2 DefaultCollection.vue

这是通用的集合详情页，自动根据路由参数加载对应集合的数据。

```vue
<template>
  <div class="collection-page">
    <!-- 页面头部 -->
    <CollectionPageHeader
      :collection-name="collectionName"
      :display-name="collectionInfo?.display_name"
      @show-overview="overviewDialogVisible = true"
      @update-command="handleUpdateCommand"
      @clear-data="handleClearData"
    />

    <!-- 数据表格 -->
    <CollectionDataTable
      :data="items"
      :fields="fields"
      :total="total"
      :loading="loading"
      @page-change="loadData"
      @sort-change="handleSortChange"
    />

    <!-- API更新对话框 -->
    <el-dialog v-model="apiRefreshDialogVisible" title="API更新">
      <!-- 单条更新 -->
      <template v-if="updateConfig?.single_update?.enabled">
        <el-card>
          <el-form>
            <el-form-item 
              v-for="param in updateConfig.single_update.params"
              :label="param.label"
            >
              <el-input v-model="singleUpdateParams[param.name]" />
            </el-form-item>
          </el-form>
          <el-button @click="handleSingleUpdate">更新</el-button>
        </el-card>
      </template>
      
      <!-- 批量更新 -->
      <template v-if="updateConfig?.batch_update?.enabled">
        <el-card>
          <el-radio-group v-model="updateMode">
            <el-radio label="incremental">增量更新</el-radio>
            <el-radio label="full">全量更新</el-radio>
          </el-radio-group>
          <el-button @click="handleBatchUpdate">批量更新</el-button>
        </el-card>
      </template>
      
      <!-- 进度显示 -->
      <el-progress :percentage="progressPercentage" />
    </el-dialog>

    <!-- 其他对话框... -->
  </div>
</template>

<script setup lang="ts">
import { useFundCollection } from '@/components/collection'

const {
  collectionName,
  items,
  fields,
  total,
  loading,
  updateConfig,
  singleUpdateParams,
  batchUpdateParams,
  updateMode,
  progressPercentage,
  loadData,
  handleSingleUpdate,
  handleBatchUpdate,
  handleClearData,
} = useFundCollection()
</script>
```

---

## 4. 集合类型分类

### 4.1 按数据获取方式分类

| 类型 | 特点 | 更新方式 | 示例 |
|------|------|----------|------|
| **无参数集合** | 一次API调用获取全部数据 | 只有批量更新 | `fund_name_em`, `fund_etf_spot_em` |
| **单参数集合** | 需要代码参数 | 单条+批量 | `fund_open_fund_info_em` |
| **多参数集合** | 需要代码+年份等参数 | 单条+批量 | `fund_portfolio_hold_em` |
| **日期参数集合** | 需要日期参数 | 单条+批量 | `fund_rating_sh_em` |

### 4.2 按更新策略分类

| 策略 | 说明 | 配置 |
|------|------|------|
| **全量更新** | 清空后重新获取 | `update_mode: "full"` |
| **增量更新** | 只获取新数据 | `update_mode: "incremental"` |
| **去重保存** | 根据唯一键去重 | `unique_keys: [...]` |

---

## 5. 完整示例

### 5.1 添加新集合：`fund_example`

#### Step 1: 创建Provider

```python
# app/services/data_sources/funds/providers/fund_example_provider.py
from app.services.data_sources.base_provider import SimpleProvider


class FundExampleProvider(SimpleProvider):
    """基金示例数据提供者"""
    
    collection_name = "fund_example"
    display_name = "基金示例"
    akshare_func = "fund_example_function"  # akshare函数名
    unique_keys = ["基金代码"]
    
    collection_description = "这是一个示例集合"
    collection_route = "/funds/collections/fund_example"
    collection_order = 100
    
    field_info = [
        {"name": "基金代码", "type": "string", "description": ""},
        {"name": "基金名称", "type": "string", "description": ""},
        {"name": "净值", "type": "float", "description": ""},
        {"name": "更新时间", "type": "datetime", "description": ""},
    ]
```

#### Step 2: 创建Service

```python
# app/services/data_sources/funds/services/fund_example_service.py
from app.services.data_sources.base_service import SimpleService
from ..providers.fund_example_provider import FundExampleProvider


class FundExampleService(SimpleService):
    """基金示例服务"""
    
    collection_name = "fund_example"
    provider_class = FundExampleProvider
```

#### Step 3: 添加元信息（可选）

```python
# app/services/data_sources/funds/collection_metadata.py
FUND_COLLECTION_METADATA = {
    # ... 其他集合
    'fund_example': {
        'display_name': '基金示例',
        'description': '这是一个示例集合',
        'route': '/funds/collections/fund_example',
        'order': 100,
    },
}
```

#### Step 4: 添加更新配置（可选）

```python
# app/config/fund_update_config.py
FUND_UPDATE_CONFIGS = {
    # ... 其他集合
    "fund_example": {
        "display_name": "基金示例",
        "update_description": "获取基金示例数据",
        "single_update": {
            "enabled": False,
            "description": "",
            "params": []
        },
        "batch_update": {
            "enabled": True,
            "description": "一次性获取所有数据",
            "params": [
                {
                    "name": "concurrency",
                    "label": "并发数",
                    "type": "number",
                    "default": 3,
                    "min": 1,
                    "max": 10,
                    "step": 1
                }
            ]
        }
    },
}
```

#### Step 5: 完成！

由于使用了自动注册机制，**无需修改**：
- ✅ 路由配置（自动注册）
- ✅ 前端API（通用）
- ✅ 前端组件（通用）
- ✅ 前端路由（动态路由）

重启后端服务后，新集合会自动出现在集合列表中。

---

## 6. 核心功能清单

### 6.1 每个数据集合支持的功能

| 功能 | API端点 | 说明 |
|------|---------|------|
| **查看数据** | `GET /collections/{name}` | 分页、排序、筛选 |
| **数据统计** | `GET /collections/{name}/stats` | 总数、最新时间等 |
| **单条更新** | `POST /collections/{name}/refresh` | 更新单条数据 |
| **批量更新** | `POST /collections/{name}/refresh` | 批量更新数据 |
| **增量更新** | `POST /collections/{name}/refresh` | 只更新新数据 |
| **全量更新** | `POST /collections/{name}/refresh` | 清空后重新获取 |
| **实时进度** | `GET /collections/{name}/refresh/status/{task_id}` | 查看更新进度 |
| **清空数据** | `DELETE /collections/{name}/clear` | 清空集合数据 |
| **导出数据** | `POST /collections/{name}/export` | CSV/Excel/JSON |
| **文件导入** | `POST /collections/{name}/upload` | 上传CSV/Excel |
| **远程同步** | `POST /collections/{name}/sync` | 从远程MongoDB同步 |
| **更新配置** | `GET /collections/{name}/update-config` | 获取更新参数配置 |

### 6.2 前端UI功能

| 功能 | 组件 | 说明 |
|------|------|------|
| **数据表格** | CollectionDataTable | 分页、排序、搜索、列宽调整 |
| **数据概览** | CollectionOverviewDialog | 总数、字段数、最新更新时间 |
| **API更新** | 对话框 | 单条/批量更新、增量/全量模式 |
| **进度显示** | el-progress | 实时显示更新进度 |
| **文件导入** | FileImportDialog | CSV/Excel文件上传 |
| **远程同步** | RemoteSyncDialog | MongoDB远程同步 |
| **数据导出** | 按钮 | CSV/Excel/JSON导出 |
| **清空数据** | 按钮 | 确认后清空 |

---

## 7. 测试与验证

### 7.1 后端测试

```bash
# 1. 测试Provider
python -c "
from app.services.data_sources.funds.providers.fund_example_provider import FundExampleProvider
provider = FundExampleProvider()
df = provider.fetch_data()
print(df.head())
"

# 2. 测试API
curl http://localhost:8000/api/funds/collections/fund_example
curl http://localhost:8000/api/funds/collections/fund_example/stats
```

### 7.2 前端验证

1. 访问 `/funds/collections` 确认新集合出现在列表中
2. 点击进入集合详情页
3. 测试数据加载、分页、排序
4. 测试更新功能（单条/批量）
5. 测试导出功能

### 7.3 常见问题排查

| 问题 | 可能原因 | 解决方案 |
|------|----------|----------|
| 集合不显示 | Provider未注册 | 检查文件名和类定义 |
| 更新失败 | akshare函数名错误 | 检查`akshare_func` |
| 数据重复 | unique_keys配置错误 | 检查唯一键字段 |
| 进度不更新 | task_id未传递 | 检查Service调用 |
| 参数无效 | param_mapping错误 | 检查参数映射 |

---

## 附录：快速检查清单

实现新集合时，确认以下内容：

### 后端
- [ ] 创建Provider文件：`providers/fund_xxx_provider.py`
- [ ] 定义必填属性：`collection_name`, `display_name`, `akshare_func`, `unique_keys`
- [ ] （可选）创建Service文件：`services/fund_xxx_service.py`
- [ ] （可选）配置批量更新：`batch_source_collection`, `batch_source_field`
- [ ] （可选）添加元信息：`collection_metadata.py`
- [ ] （可选）添加更新配置：`fund_update_config.py`

### 前端
- [ ] 无需修改（使用通用组件）

### 验证
- [ ] 重启后端服务
- [ ] 刷新前端页面
- [ ] 确认集合出现在列表
- [ ] 测试数据加载
- [ ] 测试更新功能

---

*文档最后更新：2024年12月*

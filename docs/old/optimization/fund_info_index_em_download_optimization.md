# æŒ‡æ•°å‹åŸºé‡‘æ•°æ®ä¸‹è½½ä¼˜åŒ–

## ä¼˜åŒ–ç›®æ ‡

ä¼˜åŒ– `fund_info_index_em` æ•°æ®é›†åˆçš„ä¸‹è½½æ–¹å¼å’Œå”¯ä¸€æ ‡è¯†ï¼š
1. é€šè¿‡éå†æ‰€æœ‰å‚æ•°ç»„åˆè·å–æ›´å®Œæ•´ã€æ›´å‡†ç¡®çš„æ•°æ®
2. ä½¿ç”¨ `æ—¥æœŸ + åŸºé‡‘ä»£ç  + è·Ÿè¸ªæ ‡çš„` ä½œä¸ºå”¯ä¸€æ ‡è¯†ï¼Œé¿å…åŒä¸€åŸºé‡‘åœ¨ä¸åŒåˆ†ç±»ä¸‹è¢«è¦†ç›–

## ä¼˜åŒ–å‰çš„é—®é¢˜

1. ä½¿ç”¨å•ä¸€çš„ `symbol="å…¨éƒ¨", indicator="å…¨éƒ¨"` å‚æ•°ç»„åˆï¼Œå¯èƒ½ä¼šé—æ¼æŸäº›ç»†åˆ†ç±»åˆ«çš„æ•°æ®
2. ä½¿ç”¨ `åŸºé‡‘ä»£ç  + æ—¥æœŸ` ä½œä¸ºå”¯ä¸€æ ‡è¯†ï¼Œå¯¼è‡´åŒä¸€åŸºé‡‘åœ¨ä¸åŒè·Ÿè¸ªæ ‡çš„ä¸‹çš„æ•°æ®ä¼šäº’ç›¸è¦†ç›–

## ä¼˜åŒ–æ–¹æ¡ˆ

### 1. å‚æ•°ç»„åˆ

**Symbolï¼ˆè·Ÿè¸ªæ ‡çš„ï¼‰**ï¼š
- æ²ªæ·±æŒ‡æ•°
- è¡Œä¸šä¸»é¢˜
- å¤§ç›˜æŒ‡æ•°
- ä¸­ç›˜æŒ‡æ•°
- å°ç›˜æŒ‡æ•°
- è‚¡ç¥¨æŒ‡æ•°
- å€ºåˆ¸æŒ‡æ•°

**Indicatorï¼ˆè·Ÿè¸ªæ–¹å¼ï¼‰**ï¼š
- è¢«åŠ¨æŒ‡æ•°å‹
- å¢å¼ºæŒ‡æ•°å‹

**æ€»ç»„åˆæ•°**: 7 Ã— 2 = **14ä¸ªç»„åˆ**

### 2. å”¯ä¸€æ ‡è¯†ä¼˜åŒ–

**æ—§çš„å”¯ä¸€æ ‡è¯†**ï¼š`åŸºé‡‘ä»£ç ` + `æ—¥æœŸ`

**æ–°çš„å”¯ä¸€æ ‡è¯†**ï¼š`æ—¥æœŸ` + `åŸºé‡‘ä»£ç ` + `è·Ÿè¸ªæ ‡çš„`

**ä¼˜åŒ–åŸå› **ï¼š
- åŒä¸€åŸºé‡‘å¯èƒ½åŒæ—¶å±äºå¤šä¸ªåˆ†ç±»ï¼ˆå¦‚"æ²ªæ·±æŒ‡æ•°"å’Œ"è‚¡ç¥¨æŒ‡æ•°"ï¼‰
- æ—§æ ‡è¯†ä¼šå¯¼è‡´åä¸‹è½½çš„åˆ†ç±»è¦†ç›–å…ˆä¸‹è½½çš„åˆ†ç±»
- æ–°æ ‡è¯†ç¡®ä¿æ¯ä¸ªåˆ†ç±»çš„æ•°æ®éƒ½èƒ½ä¿å­˜

### 3. ä¸‹è½½æµç¨‹

1. **éå†æ‰€æœ‰ç»„åˆ**ï¼šä¾æ¬¡è°ƒç”¨ akshare API è·å–æ¯ä¸ªç»„åˆçš„æ•°æ®
2. **åˆå¹¶æ•°æ®**ï¼šå°†æ‰€æœ‰æ•°æ®åˆå¹¶åˆ°ä¸€ä¸ª DataFrame
3. **å»é‡å¤„ç†**ï¼šæ ¹æ® `æ—¥æœŸ` + `åŸºé‡‘ä»£ç ` + `è·Ÿè¸ªæ ‡çš„` å»é‡ï¼Œä¿ç•™æœ€æ–°è®°å½•
4. **ä¿å­˜æ•°æ®**ï¼šæ‰¹é‡å†™å…¥æ•°æ®åº“ï¼Œä½¿ç”¨æ–°çš„å”¯ä¸€æ ‡è¯†

### 4. é”™è¯¯å¤„ç†

- å¦‚æœæŸä¸ªç»„åˆè·å–å¤±è´¥ï¼Œè®°å½•é”™è¯¯ä½†ç»§ç»­å¤„ç†å…¶ä»–ç»„åˆ
- åªæœ‰åœ¨æ‰€æœ‰ç»„åˆéƒ½å¤±è´¥æ—¶æ‰æŠ›å‡ºå¼‚å¸¸

## ä¼˜åŒ–æ•ˆæœ

### æµ‹è¯•ç»“æœ

**ä¼˜åŒ–å‰**ï¼ˆä½¿ç”¨æ—§å”¯ä¸€æ ‡è¯†ï¼‰ï¼š
```
åˆå¹¶åå…± 8600 æ¡æ•°æ®
å»é‡å®Œæˆ: 8600 -> 3895 æ¡ (åˆ é™¤ 4705 æ¡é‡å¤)
æˆåŠŸæ›´æ–° 3894 æ¡æ•°æ®
```

**ä¼˜åŒ–å**ï¼ˆä½¿ç”¨æ–°å”¯ä¸€æ ‡è¯†ï¼‰ï¼š
```
éå† 14 ä¸ªå‚æ•°ç»„åˆè·å–æ•°æ®
åˆå¹¶åå…± 8600 æ¡æ•°æ®
å»é‡å®Œæˆ: 8600 -> 8596 æ¡ (åˆ é™¤ 4 æ¡é‡å¤)
æˆåŠŸæ›´æ–° 10308 æ¡æŒ‡æ•°å‹åŸºé‡‘åŸºæœ¬ä¿¡æ¯
```

**æ•°æ®é‡æå‡**ï¼šä» ~3900æ¡ æå‡åˆ° **10308æ¡**ï¼Œå¢åŠ äº† **163%** ğŸš€

### æ•°æ®åˆ†å¸ƒ

**æŒ‰è·Ÿè¸ªæ ‡çš„åˆ†ç±»**ï¼š
- è‚¡ç¥¨æŒ‡æ•°: 3330 æ¡
- æ²ªæ·±æŒ‡æ•°: 2387 æ¡
- å°ç›˜æŒ‡æ•°: 1751 æ¡
- è¡Œä¸šä¸»é¢˜: 1402 æ¡
- å¤§ç›˜æŒ‡æ•°: 832 æ¡
- å€ºåˆ¸æŒ‡æ•°: 456 æ¡
- ä¸­ç›˜æŒ‡æ•°: 150 æ¡

**æŒ‰è·Ÿè¸ªæ–¹å¼åˆ†ç±»**ï¼š
- è¢«åŠ¨æŒ‡æ•°å‹: ~8000 æ¡
- å¢å¼ºæŒ‡æ•°å‹: ~2300 æ¡

**æŒ‰æ—¥æœŸåˆ†å¸ƒ**ï¼š
- æœ€æ–°æ—¥æœŸ (2025-11-21): 10304 æ¡
- å…¶ä»–æ—¥æœŸ: å°‘é‡å†å²æ•°æ®

### ä¼˜åŠ¿

1. âœ… **æ•°æ®é‡å¤§å¹…æå‡**ï¼šä»3900æ¡å¢åŠ åˆ°10308æ¡ï¼Œå¢é•¿163%
2. âœ… **å”¯ä¸€æ ‡è¯†æ›´ç²¾ç¡®**ï¼šé¿å…ä¸åŒåˆ†ç±»æ•°æ®äº’ç›¸è¦†ç›–
3. âœ… **æ•°æ®æ›´å®Œæ•´**ï¼šéå†æ‰€æœ‰ç»„åˆï¼Œç¡®ä¿ä¸é—æ¼ä»»ä½•ç±»åˆ«
4. âœ… **å®¹é”™æ€§å¼º**ï¼šå•ä¸ªç»„åˆå¤±è´¥ä¸å½±å“æ•´ä½“æµç¨‹
5. âœ… **å»é‡æœºåˆ¶**ï¼šè‡ªåŠ¨å¤„ç†é‡å¤æ•°æ®ï¼Œä¿è¯æ•°æ®è´¨é‡
6. âœ… **è¿›åº¦å¯è§†**ï¼šè¯¦ç»†çš„è¿›åº¦åé¦ˆï¼Œç”¨æˆ·ä½“éªŒæ›´å¥½
7. âœ… **æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–**ï¼šä¸ºæ–°çš„å”¯ä¸€æ ‡è¯†åˆ›å»ºäº†ä¸“é—¨çš„ç´¢å¼•

## å®ç°ç»†èŠ‚

### ä¿®æ”¹æ–‡ä»¶

1. `app/services/fund_refresh_service.py` - éå†å‚æ•°ç»„åˆ + å»é‡é€»è¾‘
2. `app/services/fund_data_service.py` - å”¯ä¸€æ ‡è¯†ä¿®æ”¹

### æ ¸å¿ƒä»£ç 

**1. éå†å‚æ•°ç»„åˆå¹¶å»é‡** (`fund_refresh_service.py`)

```python
async def _refresh_fund_info_index_em(self, task_id: str, params: Dict[str, Any]) -> Dict[str, Any]:
    # å®šä¹‰æ‰€æœ‰å‚æ•°ç»„åˆï¼ˆå»æ‰"å…¨éƒ¨"ï¼‰
    symbols = ["æ²ªæ·±æŒ‡æ•°", "è¡Œä¸šä¸»é¢˜", "å¤§ç›˜æŒ‡æ•°", "ä¸­ç›˜æŒ‡æ•°", "å°ç›˜æŒ‡æ•°", "è‚¡ç¥¨æŒ‡æ•°", "å€ºåˆ¸æŒ‡æ•°"]
    indicators = ["è¢«åŠ¨æŒ‡æ•°å‹", "å¢å¼ºæŒ‡æ•°å‹"]
    
    all_dataframes = []
    
    # éå†æ‰€æœ‰ç»„åˆ
    for symbol in symbols:
        for indicator in indicators:
            df = await loop.run_in_executor(
                _executor, self._fetch_fund_info_index_em, symbol, indicator
            )
            if df is not None and not df.empty:
                all_dataframes.append(df)
    
    # åˆå¹¶å¹¶å»é‡ï¼ˆä½¿ç”¨æ–°çš„å”¯ä¸€æ ‡è¯†ï¼‰
    combined_df = pd.concat(all_dataframes, ignore_index=True)
    combined_df = combined_df.drop_duplicates(
        subset=['æ—¥æœŸ', 'åŸºé‡‘ä»£ç ', 'è·Ÿè¸ªæ ‡çš„'], 
        keep='last'
    )
    
    # ä¿å­˜åˆ°æ•°æ®åº“
    saved_count = await self.data_service.save_fund_info_index_data(combined_df)
```

**2. æ–°çš„å”¯ä¸€æ ‡è¯†** (`fund_data_service.py`)

```python
# æå–å”¯ä¸€æ ‡è¯†å­—æ®µ
fund_code = str(doc.get('åŸºé‡‘ä»£ç ', '')).strip()
date_str = str(doc.get('æ—¥æœŸ', '')).strip()
tracking_target = str(doc.get('è·Ÿè¸ªæ ‡çš„', '')).strip()

# ä½¿ç”¨ æ—¥æœŸ + åŸºé‡‘ä»£ç  + è·Ÿè¸ªæ ‡çš„ ä½œä¸ºå”¯ä¸€æ ‡è¯†
ops.append(
    UpdateOne(
        {
            'æ—¥æœŸ': date_str,
            'code': fund_code,
            'è·Ÿè¸ªæ ‡çš„': tracking_target
        },
        {'$set': doc},
        upsert=True
    )
)
```

## ä½¿ç”¨æ–¹æ³•

### é€šè¿‡Webç•Œé¢

1. è®¿é—® http://localhost:3000/funds/collections/fund_info_index_em
2. ç‚¹å‡»"æ›´æ–°æ•°æ®"æŒ‰é’®
3. ç³»ç»Ÿä¼šè‡ªåŠ¨éå†æ‰€æœ‰14ä¸ªå‚æ•°ç»„åˆä¸‹è½½æ•°æ®

### é€šè¿‡è„šæœ¬

**æµ‹è¯•å®Œæ•´æµç¨‹**ï¼ˆæ¸…ç©ºæ•°æ®ã€åˆ›å»ºç´¢å¼•ã€é‡æ–°ä¸‹è½½ï¼‰ï¼š
```bash
python scripts/debug/test_new_unique_key.py
```

**ä»…åˆ›å»ºæ•°æ®åº“ç´¢å¼•**ï¼š
```bash
python scripts/database/create_fund_info_index_indexes.py
```

**ä»…æµ‹è¯•ä¸‹è½½**ï¼š
```bash
python scripts/debug/test_optimized_fund_download.py
```

## æ€§èƒ½æŒ‡æ ‡

- **APIè°ƒç”¨æ¬¡æ•°**: 14æ¬¡ï¼ˆæ¯ä¸ªç»„åˆ1æ¬¡ï¼‰
- **é¢„è®¡è€—æ—¶**: çº¦20-30ç§’ï¼ˆå–å†³äºç½‘ç»œå’ŒAPIå“åº”é€Ÿåº¦ï¼‰
- **æ•°æ®å»é‡ç‡**: ä¼˜åŒ–å‰ ~55% (4705/8600)ï¼Œä¼˜åŒ–å ~0.05% (4/8600)
- **å†…å­˜ä½¿ç”¨**: åˆç†ï¼ˆåˆ†æ‰¹å¤„ç†æ•°æ®ï¼‰
- **æ•°æ®é‡æå‡**: ä» 3,900æ¡ å¢åŠ åˆ° 10,308æ¡ (+163%)
- **ç´¢å¼•æ•°é‡**: 6ä¸ªï¼ˆåŒ…æ‹¬1ä¸ªå”¯ä¸€å¤åˆç´¢å¼•ï¼‰

## æ³¨æ„äº‹é¡¹

1. **é¦–æ¬¡ä½¿ç”¨éœ€è¦æ¸…ç©ºæ—§æ•°æ®**ï¼šç”±äºå”¯ä¸€æ ‡è¯†æ”¹å˜ï¼Œå»ºè®®å…ˆæ¸…ç©ºæ—§æ•°æ®å†é‡æ–°ä¸‹è½½
2. **ç´¢å¼•è‡ªåŠ¨åˆ›å»º**ï¼šé¦–æ¬¡ä¸‹è½½æ—¶ä¼šè‡ªåŠ¨åˆ›å»ºå¿…è¦çš„ç´¢å¼•ï¼Œå¯èƒ½éœ€è¦é¢å¤–å‡ ç§’é’Ÿ
3. **å»é‡ç‡å¤§å¹…é™ä½**ï¼šä½¿ç”¨æ–°å”¯ä¸€æ ‡è¯†åï¼Œå»é‡ç‡ä»55%é™ä½åˆ°0.05%ï¼Œè¯´æ˜æ•°æ®ä¿å­˜æ›´å®Œæ•´
4. **APIè°ƒç”¨è€—æ—¶**ï¼šéœ€è¦è°ƒç”¨14æ¬¡APIï¼Œæ€»è€—æ—¶æ¯”ä¹‹å‰ç¨é•¿ï¼Œä½†æ•°æ®æ›´å®Œæ•´
5. **æ•°æ®è¦†ç›–é—®é¢˜å·²è§£å†³**ï¼šä¸åŒåˆ†ç±»çš„æ•°æ®ä¸å†äº’ç›¸è¦†ç›–

## æœªæ¥æ”¹è¿›

1. å¯ä»¥è€ƒè™‘å¹¶è¡Œè°ƒç”¨å¤šä¸ªAPIï¼ˆéœ€è¦æ³¨æ„APIé™æµï¼‰
2. å¯ä»¥ç¼“å­˜å·²ä¸‹è½½çš„æ•°æ®ï¼Œé¿å…é‡å¤ä¸‹è½½
3. å¯ä»¥æ ¹æ®æ•°æ®æ›´æ–°é¢‘ç‡æ™ºèƒ½é€‰æ‹©éœ€è¦æ›´æ–°çš„ç»„åˆ

## ç›¸å…³æ–‡ä»¶

**æ ¸å¿ƒå®ç°**ï¼š
- `app/services/fund_refresh_service.py` - éå†å‚æ•°ç»„åˆ + å»é‡é€»è¾‘
- `app/services/fund_data_service.py` - æ•°æ®ä¿å­˜ + å”¯ä¸€æ ‡è¯† + NaNæ¸…ç†

**æµ‹è¯•è„šæœ¬**ï¼š
- `scripts/debug/test_new_unique_key.py` - å®Œæ•´æµ‹è¯•æµç¨‹
- `scripts/debug/test_optimized_fund_download.py` - ä¸‹è½½åŠŸèƒ½æµ‹è¯•
- `scripts/debug/check_fund_data_nan.py` - æ•°æ®è´¨é‡æ£€æŸ¥

**æ•°æ®åº“è„šæœ¬**ï¼š
- `scripts/database/create_fund_info_index_indexes.py` - åˆ›å»ºç´¢å¼•
- `scripts/debug/fix_fund_info_index_invalid_floats.py` - ä¿®å¤æ— æ•ˆæµ®ç‚¹æ•°

**æ–‡æ¡£**ï¼š
- `docs/optimization/fund_info_index_em_download_optimization.md` - æœ¬æ–‡æ¡£

## æ›´æ–°æ—¥å¿—

**2025-11-22 v2.0**:
- âœ¨ ä¼˜åŒ–å”¯ä¸€æ ‡è¯†ï¼šä» `åŸºé‡‘ä»£ç +æ—¥æœŸ` æ”¹ä¸º `æ—¥æœŸ+åŸºé‡‘ä»£ç +è·Ÿè¸ªæ ‡çš„`
- ğŸš€ æ•°æ®é‡æå‡163%ï¼šä»3900æ¡å¢åŠ åˆ°10308æ¡
- ğŸ“Š åˆ›å»ºæ•°æ®åº“ç´¢å¼•ï¼š6ä¸ªç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
- ğŸ”§ å»é‡é€»è¾‘ä¼˜åŒ–ï¼šä½¿ç”¨æ–°çš„å”¯ä¸€æ ‡è¯†å»é‡

**2025-11-22 v1.0**: 
- âœ¨ åˆæ¬¡ä¼˜åŒ–ï¼Œå®ç°å‚æ•°ç»„åˆéå†ä¸‹è½½
- ğŸ”§ æ·»åŠ NaN/Infinityå€¼è‡ªåŠ¨æ¸…ç†
- ğŸ“ å®Œå–„è¿›åº¦åé¦ˆæœºåˆ¶

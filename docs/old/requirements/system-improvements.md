# 改进优化建议（后端/前端/工程化）

下面基于当前架构与近期问题点，给出可落地的改进建议，按优先级与影响面排序。

## 后端

- **[统一符号标准化服务]**
  - 将各市场/资产的代码转换集中到 `utils/instrument_validator.py`（或新增 `instrument_codes.py`）。
  - 产出清晰的转换规则：内部标准符号 ↔ Provider 各自符号（AKShare/Tushare/BaoStock）。
  - 为关键映射写单测（示例集覆盖 A 股/港股/美股/指数/基金/期货/债券）。

- **[Provider 抽象与解耦]**
  - 定义统一的 Provider 基类协议（异步接口：基础信息/历史数据/快照/列表）。
  - Provider 内部所有阻塞 IO 全部 `asyncio.to_thread`，Manager 侧统一 `_run_coro_safely`。
  - 输出统一列名标准化函数（复用现有股票标准化的范式），为各资产建立各自标准字段。

- **[事件循环与并发规范化]**
  - 禁止在同步上下文直接 `loop.run_until_complete`。统一经 `DataSourceManager._run_coro_safely`。
  - 在批量拉取/指标计算场景中使用受限并发（`asyncio.Semaphore`），避免打爆免费数据源/网络。

- **[降级与韧性增强]**
  - 为每类资产维护独立的优先级与降级链（DB → 主源 → 备用1 → 备用2），并支持“自适应排序”（按最近成功率与延迟动态调整）。
  - 引入简单“熔断器”（短时间内持续失败则临时跳过该 Provider，并打日志提醒）。
  - 标准化错误码（网络/限流/格式/空数据/维度不支持），Manager 统一封装为结构化错误返回给上层。

- **[缓存与持久化]**
  - Mongo 分层设计：基础信息集合、日线集合（指数、基金 NAV、期货含 open_interest、债券净价/全价可选）。
  - 增加 TTL / 数据新鲜度字段与索引；常用读路径优先缓存命中（Mongo 命中 → 直接格式化返回）。
  - 小体量元数据以内存 LRU 缓存辅助（如代码映射、基础信息）。

- **[性能与数据质量]**
  - 批量拉取优先（例如基金/指数批量历史接口），减少 N+1。
  - 指标计算向向量化收敛；可选将部分指标提前在入库后批处理预计算。
  - 数据校验：日期单调/去重/缺失填补/异常跳变提示（日志与告警）。

- **[API 与统一输出]**
  - API 输出使用统一“结果对象”（ok/err/provider/trace_id/summary/data），同时保留当前的字符串报表用于 UI。
  - 列表接口分页与缓存（基金/指数清单）；增加 ETag/压缩。
  - 为指数新增 `get_index_data_unified/get_index_info_unified`，并与基金基准对齐（用于跟踪误差分析）。

- **[配置与安全]**
  - 强化 `.env` 校验（缺失 Token/配置不合法时启动即报错）；提供样例 `.env.example`。
  - Provider 访问层增加超时/重试/退避策略；支持代理/区域镜像。

- **[日志与可观测性]**
  - 统一 trace_id 贯穿接口 → Manager → Provider → 缓存。
  - 关键日志规范：资产/代码/来源/耗时/数据条数/缓存命中/降级路径。
  - 指标上报（可 Prometheus）：成功率、错误分布、数据新鲜度、各 Provider 延迟。

- **[测试体系]**
  - 单元：符号映射、列名标准化、指标计算。
  - 集成：小样本联网拉取 + Mongo 命中/写入/读取一致性。
  - 端到端：统一接口到日志/返回无异常；使用 VCR/录制以减少对外部依赖。
  - 合同测试：约束 Provider 输出与统一模型对齐。

- **[代码结构与可维护性]**
  - 拆分超大模块（如 DataSourceManager）为领域子模块：缓存、降级策略、格式化、资产路由、Provider 适配层。
  - 公共格式化/指标计算抽到 `indicators/formatters`，避免重复实现。

## 前端

- **[信息架构与路由]**
  - 导航按资产分组：股票、基金、指数、期货、债券；各自入口页与详情页。
  - 代码输入组件“资产感知”与智能提示（sz/sh、期货合约月份、基金代码/指数代码）。

- **[图表与分析]**
  - 通用：K 线/面积/NAV 曲线，指标开关（MA/MACD/RSI/BOLL）。
  - 基金 vs 指数：基准选择、跟踪误差曲线与统计。
  - 期货：主力/具体合约切换、换月标记、持仓量显示。
  - 债券：净价/全价（若有）与收益率简报（可选）。

- **[可用性与反馈]**
  - 骨架屏/重试/缓存命中与数据来源徽标（Mongo/AKShare/Tushare）。
  - 保留用户偏好（资产类/日期范围/指标）至本地存储。
  - 错误反馈友好化：明确错误码/解决建议。

- **[性能与工程]**
  - 图表虚拟化/懒加载；接口层加取消/去抖。
  - 组件库标准化（指标开关、数据表、对比面板）与 Storybook 文档（可选）。
  - API 客户端统一封装（超时/重试/错误码映射）。

## 工程化与运维

- **[质量门禁]**
  - pre-commit（ruff/black/isort/mypy）+ 单测与集测门槛。
  - CI 分流：离线单测与联网集测；录制/回放减少外部波动。

- **[监控与报警]**
  - 关键指标阈值报警（失败率、延迟、数据新鲜度）。
  - Sentry/日志聚合（按 trace_id 检索全链路）。

- **[发布与回滚]**
  - 分支策略（feature → develop → main），小批量频发布。
  - 可选蓝绿/灰度；配置/数据源优先级热更新机制（来自 DB）。

## 优先落地清单（建议顺序）

- **[P0]** 统一符号标准化服务 + Provider 抽象与 `_run_coro_safely` 全面覆盖 + 降级与错误码规范
- **[P1]** 缓存与索引完善（Mongo 命中优先）+ 结构化日志与指标上报
- **[P2]** 基金/指数/期货/债券的统一接口与小样本集成测试（先单一数据源，再加降级）
- **[P3]** 前端资产分组导航与统一图表/对比组件 + 错误体验提升
- **[P4]** 批量拉取与受限并发 + 预计算/向量化优化 + 自适应优先级/熔断

# 批量更新数据保存流程图

## 完整流程图

```
┌─────────────────────────────────────────────────────────────────┐
│  1. 批量更新入口 (_full_batch_update)                          │
│  - 从源集合获取基金代码列表 (1300个)                            │
│  - 检查已有数据，过滤出需要处理的任务                           │
└──────────────────────┬──────────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────────┐
│  2. 并发任务执行 (_execute_batch_tasks)                         │
│  ┌──────────────────────┐  ┌──────────────────────┐            │
│  │  process_task (协程1)│  │  process_task (协程2)│  ...      │
│  │  - 获取基金A数据     │  │  - 获取基金B数据     │            │
│  │  - DataFrame → 队列 │  │  - DataFrame → 队列   │            │
│  └──────────┬───────────┘  └──────────┬───────────┘            │
│             │                          │                        │
│             └──────────┬───────────────┘                        │
│                        ▼                                        │
│              ┌──────────────────┐                               │
│              │  data_queue     │  (异步队列)                    │
│              │  (DataFrame队列)│                               │
│              └────────┬─────────┘                               │
│                       │                                          │
│                       ▼                                          │
│              ┌──────────────────┐                               │
│              │  batch_saver    │  (批量保存协程)                │
│              │  - 从队列取数据  │                               │
│              │  - 累积到阈值    │                               │
│              └────────┬─────────┘                               │
└───────────────────────┼────────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────────┐
│  3. 数据合并 (save_accumulated)                                 │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐                    │
│  │ DataFrame│  │ DataFrame│  │ DataFrame│                    │
│  │ (基金A)   │  │ (基金B)   │  │ (基金C)   │                    │
│  │ 1000行   │  │ 1500行   │  │ 800行    │                    │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘                    │
│       │             │             │                           │
│       └─────────────┼─────────────┘                           │
│                     ▼                                           │
│            pd.concat(accumulated_dfs)                           │
│                     │                                           │
│                     ▼                                           │
│            combined_df (3300行)                                 │
└──────────────────────┬──────────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────────┐
│  4. 数据保存 (ControlMongodb.save_dataframe_to_collection)     │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  4.1 数据转换                                             │  │
│  │  - DataFrame → 字典列表                                   │  │
│  │  - 转换时间字段为 ISO 格式                                │  │
│  │  - 添加额外字段（数据源、接口名称等）                    │  │
│  └──────────────────────────────────────────────────────────┘  │
│                       │                                          │
│                       ▼                                          │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  4.2 构建更新操作                                         │  │
│  │  对于每条记录:                                            │  │
│  │  - 构建查询条件: {"基金代码": "511280", "净值日期": ...} │  │
│  │  - 构建 UpdateOne 操作                                    │  │
│  │  - 使用 upsert=True (不存在则插入，存在则更新)            │  │
│  └──────────────────────────────────────────────────────────┘  │
│                       │                                          │
│                       ▼                                          │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  4.3 批量执行                                             │  │
│  │  - 每 1000 条为一批                                       │  │
│  │  - 执行 bulk_write(ops, ordered=False)                   │  │
│  │  - 统计结果: upserted, matched, modified                │  │
│  └──────────────────────────────────────────────────────────┘  │
└──────────────────────┬──────────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────────┐
│  5. 去重逻辑                                                     │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  唯一键: ["基金代码", "净值日期"]                         │  │
│  │                                                            │  │
│  │  场景1: 新数据                                             │  │
│  │  基金代码: 511280, 净值日期: 2024-01-01                   │  │
│  │  → 插入新文档 (upserted)                                   │  │
│  │                                                            │  │
│  │  场景2: 数据更新                                           │  │
│  │  基金代码: 511280, 净值日期: 2024-01-01, 净值: 1.235       │  │
│  │  → 更新现有文档 (modified)                                 │  │
│  │                                                            │  │
│  │  场景3: 数据未变化                                         │  │
│  │  基金代码: 511280, 净值日期: 2024-01-01, 净值: 1.235       │  │
│  │  → 不更新 (unchanged)                                      │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

## 关键时间点

### 保存触发时机

```
时间轴:
0s ──────────────────────────────────────────────────────────> 5s
│                                                              │
├─ 获取数据 ────────────────────────────────────────────────┤
│                                                              │
│  累积数据: [1000行] [1500行] [800行] [1200行] [1000行]     │
│            │                                                │
│            └─ 达到 5000 行阈值 ──> 立即保存                │
│                                                              │
└─ 5秒间隔 ────────────────────────────────────────────────> 保存
```

### 批量写入流程

```
数据: 3300 条记录
│
├─ 第1批: 1000 条 → bulk_write → 结果1
├─ 第2批: 1000 条 → bulk_write → 结果2
├─ 第3批: 1000 条 → bulk_write → 结果3
└─ 第4批: 300 条  → bulk_write → 结果4
│
└─ 汇总: total_upserted, total_modified, unchanged
```

## 数据统计示例

### 输入
- 处理任务数: 1300 个基金代码
- 每个基金平均: 100 条历史数据
- 总数据量: 约 130,000 条记录

### 处理过程
```
并发获取: 3 个协程同时工作
├─ 协程1: 基金A (100条) → 队列
├─ 协程2: 基金B (150条) → 队列
└─ 协程3: 基金C (80条)  → 队列
    ...
```

### 批量保存
```
累积到 5000 行 → 保存
├─ 合并 DataFrame
├─ 转换为字典列表
├─ 构建更新操作 (1000条/批)
└─ 执行 bulk_write
```

### 去重结果
```
总记录数: 130,000 条
├─ 新增: 80,000 条 (upserted)
├─ 更新: 30,000 条 (modified)
└─ 未变化: 20,000 条 (unchanged)
```

### 最终统计
```
处理任务: 1300 个
成功获取: 1300 个
保存数据: 110,000 条 (新增+更新)
已保存基金: 300 个 (不重复的基金代码数)
```

## 性能指标

- **并发数**: 3 (可配置)
- **批量保存阈值**: 5000 行
- **保存间隔**: 5 秒
- **MongoDB 批量大小**: 1000 条/批
- **预计吞吐量**: 约 200-500 条/秒（取决于网络和数据库性能）

